{"ts":1359982432925,"silentsave":true,"restoring":false,"patch":[[{"diffs":[[1,"/*\n\tload the module that allows you to request JSON.\n*/\nvar json = require(\"jsonreq\"),\n\t_\t = require(\"underscore\"),\n\tdb \t = require(\"../db/queries\");\n/*\n\tLoad every 24h\n*/\nthis.update = function() {\n\tvar limit = 100\n\tjson.get(\"https://itunes.apple.com/us/rss/topsongs/limit=\" + limit + \"/explicit=true/json\", function(err, result) {\n\t\tif (!err) {\n\t\t\tvar songs = result.feed.entry;\n\t\t\tsongids = [], pureids = [];\n\t\t\t_.each(songs, function(entry) {\n\t\t\t\t/*\n\t\t\t\t\tMerge all songids together\n\t\t\t\t*/\n\t\t\t\tvar id = parseFloat(entry.id.attributes['im:id'])\n\t\t\t\tsongids.push({preview: entry.link[1].attributes.href});\n\t\t\t\tpureids.push(id);\n\t\t\t});\n\t\t\tdb.getSongsByIds(songids, function(items) {\n\t\t\t\t/*\n\t\t\t\t\tTODO: The order doesn't seem right.\n\t\t\t\t*/\n\t\t\t\tconsole.log(items.length);\n\t\t\t\tif (items.length < limit) {\n\t\t\t\t\tvar request = pureids, dbtracks = [];\n\t\t\t\t\t_.each(items, function(item) {\n\t\t\t\t\t\tdbtracks.push(item.id);\n\t\t\t\t\t})\n\t\t\t\t\tvar tofetch = (_.reject(pureids, function(item) { return _.contains(dbtracks, item) })).join(\",\");\n\t\t\t\t\t/*\n\t\t\t\t\t\tFetch missing track\n\t\t\t\t\t*/\n\t\t\t\t\tjson.get(\"https://itunes.apple.com/lookup?id=\" + tofetch + \"&entity=song\", function(err, result) {\n\t\t\t\t\t\tif (!err) {\n\t\t\t\t\t\t\tvar toadd = result.results.length;\n\t\t\t\t\t\t\t_.each(result.results, function(song) {\n\t\t\t\t\t\t\t\tvar track = {\n\t\t\t\t\t\t\t\t\tartistid: song.artistId,\n\t\t\t\t\t\t\t\t\talbumid: song.collectionId,\n\t\t\t\t\t\t\t\t\tid: song.trackId,\n\t\t\t\t\t\t\t\t\talbum: song.collectionName,\n\t\t\t\t\t\t\t\t\tartist: song.artistName,\n\t\t\t\t\t\t\t\t\tpreview: song.previewUrl,\n\t\t\t\t\t\t\t\t\timage: song.artworkUrl100,\n\t\t\t\t\t\t\t\t\tname: song.trackName,\n\t\t\t\t\t\t\t\t\trelease: song.releaseDate.substr(0,4), \n\t\t\t\t\t\t\t\t\timage: song.artworkUrl100,\n\t\t\t\t\t\t\t\t\texplicit: song.collectionExplicitness == \"explicit\" ? true : false,\n\t\t\t\t\t\t\t\t\tgenre: song.primaryGenreName,\n\t\t\t\t\t\t\t\t\tlistens: 0,\n\t\t\t\t\t\t\t\t\tduration: song.trackTimeMillis,\n\t\t\t\t\t\t\t\t\tcdinalbum: song.discNumber,\n\t\t\t\t\t\t\t\t\tcdcount: song.discCount,\n\t\t\t\t\t\t\t\t\ttracks: song.trackCount,\n\t\t\t\t\t\t\t\t\tnumberinalbum: song.trackNumber\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\titems.push(track);\n\t\t\t\t\t\t\t\tdb.addTrack(track, function() {\n\t\t\t\t\t\t\t\t\ttoadd--;\n\t\t\t\t\t\t\t\t\tif (toadd == 0) {\n\t\t\t\t\t\t\t\t\t\tcharts.update();\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t})\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t}\n\t\t\t\t\t})\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\t/*\n\t\t\t\t\t\tOrder the tracks right\n\t\t\t\t\t*/\n\t\t\t\t\tvar ordered = []\n\t\t\t\t\t_.each(pureids, function(track, key) {\n\t\t\t\t\t\tordered[key] = _.find(items, function(song) { return track == song.id });\n\t\t\t\t\t});\n\t\t\t\t\tcharts.table = ordered;\n\t\t\t\t\tsetTimeout(charts.update, 120000);\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t})\n}\nthis.table = []"]],"start1":0,"start2":0,"length1":0,"length2":2499}]],"length":2499}
{"contributors":[],"silentsave":false,"ts":1359983080657,"patch":[[{"diffs":[[0,"ar json "],[1,"   "],[0,"= requir"]],"start1":57,"start2":57,"length1":16,"length2":19},{"diffs":[[0,"eq\"),\n\t_"],[-1,"\t"],[1,"      "],[0," = requi"]],"start1":84,"start2":84,"length1":17,"length2":22},{"diffs":[[0,"\"),\n\tdb "],[-1,"\t"],[1,"    "],[0," = requi"]],"start1":120,"start2":120,"length1":17,"length2":20},{"diffs":[[0,"it = 100"],[1,";"],[0,"\n\tjson.g"]],"start1":218,"start2":218,"length1":16,"length2":17},{"diffs":[[0,"try;\n\t\t\t"],[1,"var "],[0,"songids "]],"start1":388,"start2":388,"length1":16,"length2":20},{"diffs":[[0,"im:id'])"],[1,";"],[0,"\n\t\t\t\tson"]],"start1":554,"start2":554,"length1":16,"length2":17},{"diffs":[[0,"\tvar"],[-1," request = pureids,"],[0," dbt"]],"start1":822,"start2":822,"length1":27,"length2":8},{"diffs":[[0,"id);\n\t\t\t\t\t})"],[1,";"],[0,"\n\t\t\t\t\tvar to"]],"start1":903,"start2":903,"length1":24,"length2":25},{"diffs":[[0,"), \n"],[-1,"\t\t\t\t\t\t\t\t\timage: song.artworkUrl100,\n"],[0,"\t\t\t\t"]],"start1":1612,"start2":1612,"length1":44,"length2":8},{"diffs":[[0,"Number\n\t\t\t\t\t\t\t\t}"],[1,";"],[0,"\n\t\t\t\t\t\t\t\titems.p"]],"start1":1933,"start2":1933,"length1":32,"length2":33},{"diffs":[[0,"toadd =="],[1,"="],[0," 0) {\n\t\t"]],"start1":2049,"start2":2049,"length1":16,"length2":17},{"diffs":[[0,"}\n\t\t\t\t\t\t\t\t})"],[1,";"],[0,"\n\t\t\t\t\t\t\t});\n"]],"start1":2100,"start2":2100,"length1":24,"length2":25},{"diffs":[[0,"\n\t\t\t\t\t})"],[1,";"],[0,"\n\t\t\t\t}\n\t"]],"start1":2132,"start2":2132,"length1":16,"length2":17},{"diffs":[[0,"red = []"],[1,";"],[0,"\n\t\t\t\t\t_."]],"start1":2217,"start2":2217,"length1":16,"length2":17},{"diffs":[[0,"\n\t})"],[1,";"],[0,"\n}"],[1,";"],[0,"\nthi"]],"start1":2445,"start2":2445,"length1":10,"length2":12},{"diffs":[[0,"s.table = []"],[1,";"]],"start1":2457,"start2":2457,"length1":12,"length2":13}]],"length":2470,"saved":false}
{"ts":1359984351381,"patch":[[{"diffs":[[0,"ueries\")"],[1,",\n    charts  = this"],[0,";\n/*\n\tLo"]],"start1":151,"start2":151,"length1":16,"length2":36}]],"length":2490,"saved":false}
