function listChanged(a){var b=$('[data-route="'+a.view+'"]'),c=b.find("tbody"),d=b.find(".playlist-trackcount"),e=b.find(".playlist-duration"),f=b.find(".playlist-plural-singular-tracks");$(d).text(a.trackcount);var g=parseFloat($(e).attr("data-duration"))+a.lengthdifference;return $(e).text(helpers.parsehours(g)).attr("data-duration",g),$(f).text(1==a.trackslabel?"track":"tracks"),c}function EventedArray(a){this.stack=[],this.mutationHandler=a||function(){},this.setHandler=function(a){this.mutationHandler=a},this.callHandler=function(){"function"==typeof this.mutationHandler&&this.mutationHandler()},this.push=function(a){this.stack.push(a),this.callHandler()},this.shift=function(){this.stack.shift()},this.pop=function(){return this.stack.pop()},this.getArray=function(){return this.stack},this.unshift=function(a){this.stack.unshift(a),this.callHandler()},this.clear=function(){this.stack=[],recognition.stop()}}!function(a,b,c){"function"==typeof define?define(b):"undefined"!=typeof module&&module.exports?module.exports=b():c[a]=b()}("IDBStore",function(){var a=function(a){throw a},b={storeName:"Store",storePrefix:"IDBWrapper-",dbVersion:1,keyPath:"id",autoIncrement:!0,onStoreReady:function(){},onError:a,indexes:[]},c=function(a,c){"undefined"==typeof c&&"function"==typeof a&&(c=a),"[object Object]"!=Object.prototype.toString.call(a)&&(a={});for(var d in b)this[d]="undefined"!=typeof a[d]?a[d]:b[d];this.dbName=this.storePrefix+this.storeName,this.dbVersion=parseInt(this.dbVersion,10)||1,c&&(this.onStoreReady=c),d="object"==typeof window?window:self,this.idb=d.indexedDB||d.webkitIndexedDB||d.mozIndexedDB,this.keyRange=d.IDBKeyRange||d.webkitIDBKeyRange||d.mozIDBKeyRange,this.features={hasAutoIncrement:!d.mozIndexedDB},this.consts={READ_ONLY:"readonly",READ_WRITE:"readwrite",VERSION_CHANGE:"versionchange",NEXT:"next",NEXT_NO_DUPLICATE:"nextunique",PREV:"prev",PREV_NO_DUPLICATE:"prevunique"},this.openDB()};c.prototype={constructor:c,version:"1.4.1",db:null,dbName:null,dbVersion:null,store:null,storeName:null,keyPath:null,autoIncrement:null,indexes:null,features:null,onStoreReady:null,onError:null,_insertIdCount:0,openDB:function(){var a=this.idb.open(this.dbName,this.dbVersion),b=!1;a.onerror=function(a){var b=!1;"error"in a.target?b="VersionError"==a.target.error.name:"errorCode"in a.target&&(b=12==a.target.errorCode),b?this.onError(Error("The version number provided is lower than the existing one.")):this.onError(a)}.bind(this),a.onsuccess=function(a){if(!b)if(this.db)this.onStoreReady();else if(this.db=a.target.result,"string"==typeof this.db.version)this.onError(Error("The IndexedDB implementation in this browser is outdated. Please upgrade your browser."));else if(this.db.objectStoreNames.contains(this.storeName)){this.store=this.db.transaction([this.storeName],this.consts.READ_ONLY).objectStore(this.storeName);var c=Array.prototype.slice.call(this.getIndexList());this.indexes.forEach(function(a){var d=a.name;d?(this.normalizeIndexData(a),this.hasIndex(d)?(this.indexComplies(this.store.index(d),a)||(b=!0,this.onError(Error('Cannot modify index "'+d+'" for current version. Please bump version number to '+(this.dbVersion+1)+"."))),c.splice(c.indexOf(d),1)):(b=!0,this.onError(Error('Cannot create new index "'+d+'" for current version. Please bump version number to '+(this.dbVersion+1)+".")))):(b=!0,this.onError(Error("Cannot create index: No index name given.")))},this),c.length&&(b=!0,this.onError(Error('Cannot delete index(es) "'+c.toString()+'" for current version. Please bump version number to '+(this.dbVersion+1)+"."))),b||this.onStoreReady()}else this.onError(Error("Something is wrong with the IndexedDB implementation in this browser. Please upgrade your browser."))}.bind(this),a.onupgradeneeded=function(a){this.db=a.target.result,this.db.objectStoreNames.contains(this.storeName)?this.store=a.target.transaction.objectStore(this.storeName):(a={autoIncrement:this.autoIncrement},null!==this.keyPath&&(a.keyPath=this.keyPath),this.store=this.db.createObjectStore(this.storeName,a));var c=Array.prototype.slice.call(this.getIndexList());this.indexes.forEach(function(a){var d=a.name;d||(b=!0,this.onError(Error("Cannot create index: No index name given."))),this.normalizeIndexData(a),this.hasIndex(d)?(this.indexComplies(this.store.index(d),a)||(this.store.deleteIndex(d),this.store.createIndex(d,a.keyPath,{unique:a.unique,multiEntry:a.multiEntry})),c.splice(c.indexOf(d),1)):this.store.createIndex(d,a.keyPath,{unique:a.unique,multiEntry:a.multiEntry})},this),c.length&&c.forEach(function(a){this.store.deleteIndex(a)},this)}.bind(this)},deleteDatabase:function(){this.idb.deleteDatabase&&this.idb.deleteDatabase(this.dbName)},put:function(b,c,e,f){null!==this.keyPath&&(f=e,e=c,c=b),f||(f=a),e||(e=d);var g=!1,h=null,i=this.db.transaction([this.storeName],this.consts.READ_WRITE);return i.oncomplete=function(){(g?e:f)(h)},i.onabort=f,i.onerror=f,null!==this.keyPath?(this._addIdPropertyIfNeeded(c),b=i.objectStore(this.storeName).put(c)):b=i.objectStore(this.storeName).put(c,b),b.onsuccess=function(a){g=!0,h=a.target.result},b.onerror=f,i},get:function(b,c,e){e||(e=a),c||(c=d);var f=!1,g=null,h=this.db.transaction([this.storeName],this.consts.READ_ONLY);return h.oncomplete=function(){(f?c:e)(g)},h.onabort=e,h.onerror=e,b=h.objectStore(this.storeName).get(b),b.onsuccess=function(a){f=!0,g=a.target.result},b.onerror=e,h},remove:function(b,c,e){e||(e=a),c||(c=d);var f=!1,g=null,h=this.db.transaction([this.storeName],this.consts.READ_WRITE);return h.oncomplete=function(){(f?c:e)(g)},h.onabort=e,h.onerror=e,b=h.objectStore(this.storeName)["delete"](b),b.onsuccess=function(a){f=!0,g=a.target.result},b.onerror=e,h},batch:function(b,c,e){e||(e=a),c||(c=d),"[object Array]"!=Object.prototype.toString.call(b)&&e(Error("dataArray argument must be of type Array."));var f=this.db.transaction([this.storeName],this.consts.READ_WRITE);f.oncomplete=function(){(i?c:e)(i)},f.onabort=e,f.onerror=e;var g=b.length,h=!1,i=!1,j=function(){g--,0===g&&!h&&(i=h=!0)};return b.forEach(function(a){var b=a.type,c=a.key,d=a.value,a=function(a){f.abort(),h||(h=!0,e(a,b,c))};"remove"==b?(d=f.objectStore(this.storeName)["delete"](c),d.onsuccess=j,d.onerror=a):"put"==b&&(null!==this.keyPath?(this._addIdPropertyIfNeeded(d),d=f.objectStore(this.storeName).put(d)):d=f.objectStore(this.storeName).put(d,c),d.onsuccess=j,d.onerror=a)},this),f},putBatch:function(a,b,c){return this.batch(a.map(function(a){return{type:"put",value:a}}),b,c)},removeBatch:function(a,b,c){return this.batch(a.map(function(a){return{type:"remove",key:a}}),b,c)},getBatch:function(b,c,e,f){e||(e=a),c||(c=d),f||(f="sparse"),"[object Array]"!=Object.prototype.toString.call(b)&&e(Error("keyArray argument must be of type Array."));var g=this.db.transaction([this.storeName],this.consts.READ_ONLY);g.oncomplete=function(){(j?c:e)(k)},g.onabort=e,g.onerror=e;var h=[],i=b.length,j=!1,k=null,l=function(a){a.target.result||"dense"==f?h.push(a.target.result):"sparse"==f&&h.length++,i--,0===i&&(j=!0,k=h)};return b.forEach(function(a){a=g.objectStore(this.storeName).get(a),a.onsuccess=l,a.onerror=function(a){k=a,e(a),g.abort()}},this),g},getAll:function(b,c){c||(c=a),b||(b=d);var e=this.db.transaction([this.storeName],this.consts.READ_ONLY),f=e.objectStore(this.storeName);return f.getAll?this._getAllNative(e,f,b,c):this._getAllCursor(e,f,b,c),e},_getAllNative:function(a,b,c,d){var e=!1,f=null;a.oncomplete=function(){(e?c:d)(f)},a.onabort=d,a.onerror=d,a=b.getAll(),a.onsuccess=function(a){e=!0,f=a.target.result},a.onerror=d},_getAllCursor:function(a,b,c,d){var e=[],f=!1,g=null;a.oncomplete=function(){(f?c:d)(g)},a.onabort=d,a.onerror=d,a=b.openCursor(),a.onsuccess=function(a){(a=a.target.result)?(e.push(a.value),a["continue"]()):(f=!0,g=e)},a.onError=d},clear:function(b,c){c||(c=a),b||(b=d);var e=!1,f=null,g=this.db.transaction([this.storeName],this.consts.READ_WRITE);g.oncomplete=function(){(e?b:c)(f)},g.onabort=c,g.onerror=c;var h=g.objectStore(this.storeName).clear();return h.onsuccess=function(a){e=!0,f=a.target.result},h.onerror=c,g},_addIdPropertyIfNeeded:function(a){!this.features.hasAutoIncrement&&"undefined"==typeof a[this.keyPath]&&(a[this.keyPath]=this._insertIdCount++ +Date.now())},getIndexList:function(){return this.store.indexNames},hasIndex:function(a){return this.store.indexNames.contains(a)},normalizeIndexData:function(a){a.keyPath=a.keyPath||a.name,a.unique=!!a.unique,a.multiEntry=!!a.multiEntry},indexComplies:function(a,b){return["keyPath","unique","multiEntry"].every(function(c){if("multiEntry"==c&&void 0===a[c]&&!1===b[c])return!0;if("keyPath"==c&&"[object Array]"==Object.prototype.toString.call(b[c])){var c=b.keyPath,d=a.keyPath;if("string"==typeof d)return c.toString()==d;if("function"!=typeof d.contains&&"function"!=typeof d.indexOf||d.length!==c.length)return!1;for(var e=0,f=c.length;f>e;e++)if(!(d.contains&&d.contains(c[e])||d.indexOf(-1!==c[e])))return!1;return!0}return b[c]==a[c]})},iterate:function(b,c){var c=f({index:null,order:"ASC",autoContinue:!0,filterDuplicates:!1,keyRange:null,writeAccess:!1,onEnd:null,onError:a},c||{}),d="desc"==c.order.toLowerCase()?"PREV":"NEXT";c.filterDuplicates&&(d+="_NO_DUPLICATE");var e=!1,g=this.db.transaction([this.storeName],this.consts[c.writeAccess?"READ_WRITE":"READ_ONLY"]),h=g.objectStore(this.storeName);return c.index&&(h=h.index(c.index)),g.oncomplete=function(){e?c.onEnd?c.onEnd():b(null):c.onError(null)},g.onabort=c.onError,g.onerror=c.onError,d=h.openCursor(c.keyRange,this.consts[d]),d.onerror=c.onError,d.onsuccess=function(a){(a=a.target.result)?(b(a.value,a,g),c.autoContinue&&a["continue"]()):e=!0},g},query:function(a,b){var c=[],b=b||{};return b.onEnd=function(){a(c)},this.iterate(function(a){c.push(a)},b)},count:function(b,c){var c=f({index:null,keyRange:null},c||{}),d=c.onError||a,e=!1,g=null,h=this.db.transaction([this.storeName],this.consts.READ_ONLY);h.oncomplete=function(){(e?b:d)(g)},h.onabort=d,h.onerror=d;var i=h.objectStore(this.storeName);return c.index&&(i=i.index(c.index)),i=i.count(c.keyRange),i.onsuccess=function(a){e=!0,g=a.target.result},i.onError=d,h},makeKeyRange:function(a){var b="undefined"!=typeof a.lower,c="undefined"!=typeof a.upper,d="undefined"!=typeof a.only;switch(!0){case d:a=this.keyRange.only(a.only);break;case b&&c:a=this.keyRange.bound(a.lower,a.upper,a.excludeLower,a.excludeUpper);break;case b:a=this.keyRange.lowerBound(a.lower,a.excludeLower);break;case c:a=this.keyRange.upperBound(a.upper,a.excludeUpper);break;default:throw Error('Cannot create KeyRange. Provide one or both of "lower" or "upper" value, or an "only" value.')}return a}};var d=function(){},e={},f=function(a,b){var c,d;for(c in b)d=b[c],d!==e[c]&&d!==a[c]&&(a[c]=d);return a};return c.version=c.prototype.version,c},this),function(){var a=this,b=a._,c={},d=Array.prototype,e=Object.prototype,f=Function.prototype,g=d.push,h=d.slice,i=d.concat,j=(d.unshift,e.toString),k=e.hasOwnProperty,l=d.forEach,m=d.map,n=d.reduce,o=d.reduceRight,p=d.filter,q=d.every,r=d.some,s=d.indexOf,t=d.lastIndexOf,u=Array.isArray,v=Object.keys,w=f.bind,x=function(a){return a instanceof x?a:this instanceof x?(this._wrapped=a,void 0):new x(a)};"undefined"!=typeof exports?("undefined"!=typeof module&&module.exports&&(exports=module.exports=x),exports._=x):a._=x,x.VERSION="1.4.2";var y=x.each=x.forEach=function(a,b,d){if(null!=a)if(l&&a.forEach===l)a.forEach(b,d);else if(a.length===+a.length){for(var e=0,f=a.length;f>e;e++)if(b.call(d,a[e],e,a)===c)return}else for(var g in a)if(x.has(a,g)&&b.call(d,a[g],g,a)===c)return};x.map=x.collect=function(a,b,c){var d=[];return null==a?d:m&&a.map===m?a.map(b,c):(y(a,function(a,e,f){d[d.length]=b.call(c,a,e,f)}),d)},x.reduce=x.foldl=x.inject=function(a,b,c,d){var e=arguments.length>2;if(null==a&&(a=[]),n&&a.reduce===n)return d&&(b=x.bind(b,d)),e?a.reduce(b,c):a.reduce(b);if(y(a,function(a,f,g){e?c=b.call(d,c,a,f,g):(c=a,e=!0)}),!e)throw new TypeError("Reduce of empty array with no initial value");return c},x.reduceRight=x.foldr=function(a,b,c,d){var e=arguments.length>2;if(null==a&&(a=[]),o&&a.reduceRight===o)return d&&(b=x.bind(b,d)),arguments.length>2?a.reduceRight(b,c):a.reduceRight(b);var f=a.length;if(f!==+f){var g=x.keys(a);f=g.length}if(y(a,function(h,i,j){i=g?g[--f]:--f,e?c=b.call(d,c,a[i],i,j):(c=a[i],e=!0)}),!e)throw new TypeError("Reduce of empty array with no initial value");return c},x.find=x.detect=function(a,b,c){var d;return z(a,function(a,e,f){return b.call(c,a,e,f)?(d=a,!0):void 0}),d},x.filter=x.select=function(a,b,c){var d=[];return null==a?d:p&&a.filter===p?a.filter(b,c):(y(a,function(a,e,f){b.call(c,a,e,f)&&(d[d.length]=a)}),d)},x.reject=function(a,b,c){var d=[];return null==a?d:(y(a,function(a,e,f){b.call(c,a,e,f)||(d[d.length]=a)}),d)},x.every=x.all=function(a,b,d){b||(b=x.identity);var e=!0;return null==a?e:q&&a.every===q?a.every(b,d):(y(a,function(a,f,g){return(e=e&&b.call(d,a,f,g))?void 0:c}),!!e)};var z=x.some=x.any=function(a,b,d){b||(b=x.identity);var e=!1;return null==a?e:r&&a.some===r?a.some(b,d):(y(a,function(a,f,g){return e||(e=b.call(d,a,f,g))?c:void 0}),!!e)};x.contains=x.include=function(a,b){var c=!1;return null==a?c:s&&a.indexOf===s?-1!=a.indexOf(b):c=z(a,function(a){return a===b})},x.invoke=function(a,b){var c=h.call(arguments,2);return x.map(a,function(a){return(x.isFunction(b)?b:a[b]).apply(a,c)})},x.pluck=function(a,b){return x.map(a,function(a){return a[b]})},x.where=function(a,b){return x.isEmpty(b)?[]:x.filter(a,function(a){for(var c in b)if(b[c]!==a[c])return!1;return!0})},x.max=function(a,b,c){if(!b&&x.isArray(a)&&a[0]===+a[0]&&a.length<65535)return Math.max.apply(Math,a);if(!b&&x.isEmpty(a))return-1/0;var d={computed:-1/0};return y(a,function(a,e,f){var g=b?b.call(c,a,e,f):a;g>=d.computed&&(d={value:a,computed:g})}),d.value},x.min=function(a,b,c){if(!b&&x.isArray(a)&&a[0]===+a[0]&&a.length<65535)return Math.min.apply(Math,a);if(!b&&x.isEmpty(a))return 1/0;var d={computed:1/0};return y(a,function(a,e,f){var g=b?b.call(c,a,e,f):a;g<d.computed&&(d={value:a,computed:g})}),d.value},x.shuffle=function(a){var b,c=0,d=[];return y(a,function(a){b=x.random(c++),d[c-1]=d[b],d[b]=a}),d};var A=function(a){return x.isFunction(a)?a:function(b){return b[a]}};x.sortBy=function(a,b,c){var d=A(b);return x.pluck(x.map(a,function(a,b,e){return{value:a,index:b,criteria:d.call(c,a,b,e)}}).sort(function(a,b){var c=a.criteria,d=b.criteria;if(c!==d){if(c>d||void 0===c)return 1;if(d>c||void 0===d)return-1}return a.index<b.index?-1:1}),"value")};var B=function(a,b,c,d){var e={},f=A(b);return y(a,function(b,g){var h=f.call(c,b,g,a);d(e,h,b)}),e};x.groupBy=function(a,b,c){return B(a,b,c,function(a,b,c){(x.has(a,b)?a[b]:a[b]=[]).push(c)})},x.countBy=function(a,b,c){return B(a,b,c,function(a,b){x.has(a,b)||(a[b]=0),a[b]++})},x.sortedIndex=function(a,b,c,d){c=null==c?x.identity:A(c);for(var e=c.call(d,b),f=0,g=a.length;g>f;){var h=f+g>>>1;c.call(d,a[h])<e?f=h+1:g=h}return f},x.toArray=function(a){return a?a.length===+a.length?h.call(a):x.values(a):[]},x.size=function(a){return a.length===+a.length?a.length:x.keys(a).length},x.first=x.head=x.take=function(a,b,c){return null==b||c?a[0]:h.call(a,0,b)},x.initial=function(a,b,c){return h.call(a,0,a.length-(null==b||c?1:b))},x.last=function(a,b,c){return null==b||c?a[a.length-1]:h.call(a,Math.max(a.length-b,0))},x.rest=x.tail=x.drop=function(a,b,c){return h.call(a,null==b||c?1:b)},x.compact=function(a){return x.filter(a,function(a){return!!a})};var C=function(a,b,c){return y(a,function(a){x.isArray(a)?b?g.apply(c,a):C(a,b,c):c.push(a)}),c};x.flatten=function(a,b){return C(a,b,[])},x.without=function(a){return x.difference(a,h.call(arguments,1))},x.uniq=x.unique=function(a,b,c,d){var e=c?x.map(a,c,d):a,f=[],g=[];return y(e,function(c,d){(b?d&&g[g.length-1]===c:x.contains(g,c))||(g.push(c),f.push(a[d]))}),f},x.union=function(){return x.uniq(i.apply(d,arguments))},x.intersection=function(a){var b=h.call(arguments,1);return x.filter(x.uniq(a),function(a){return x.every(b,function(b){return x.indexOf(b,a)>=0})})},x.difference=function(a){var b=i.apply(d,h.call(arguments,1));return x.filter(a,function(a){return!x.contains(b,a)})},x.zip=function(){for(var a=h.call(arguments),b=x.max(x.pluck(a,"length")),c=new Array(b),d=0;b>d;d++)c[d]=x.pluck(a,""+d);return c},x.object=function(a,b){for(var c={},d=0,e=a.length;e>d;d++)b?c[a[d]]=b[d]:c[a[d][0]]=a[d][1];return c},x.indexOf=function(a,b,c){if(null==a)return-1;var d=0,e=a.length;if(c){if("number"!=typeof c)return d=x.sortedIndex(a,b),a[d]===b?d:-1;d=0>c?Math.max(0,e+c):c}if(s&&a.indexOf===s)return a.indexOf(b,c);for(;e>d;d++)if(a[d]===b)return d;return-1},x.lastIndexOf=function(a,b,c){if(null==a)return-1;var d=null!=c;if(t&&a.lastIndexOf===t)return d?a.lastIndexOf(b,c):a.lastIndexOf(b);for(var e=d?c:a.length;e--;)if(a[e]===b)return e;return-1},x.range=function(a,b,c){arguments.length<=1&&(b=a||0,a=0),c=arguments[2]||1;for(var d=Math.max(Math.ceil((b-a)/c),0),e=0,f=new Array(d);d>e;)f[e++]=a,a+=c;return f};var D=function(){};x.bind=function(a,b){var c,d;if(a.bind===w&&w)return w.apply(a,h.call(arguments,1));if(!x.isFunction(a))throw new TypeError;return d=h.call(arguments,2),c=function(){if(!(this instanceof c))return a.apply(b,d.concat(h.call(arguments)));D.prototype=a.prototype;var e=new D,f=a.apply(e,d.concat(h.call(arguments)));return Object(f)===f?f:e}},x.bindAll=function(a){var b=h.call(arguments,1);return 0==b.length&&(b=x.functions(a)),y(b,function(b){a[b]=x.bind(a[b],a)}),a},x.memoize=function(a,b){var c={};return b||(b=x.identity),function(){var d=b.apply(this,arguments);return x.has(c,d)?c[d]:c[d]=a.apply(this,arguments)}},x.delay=function(a,b){var c=h.call(arguments,2);return setTimeout(function(){return a.apply(null,c)},b)},x.defer=function(a){return x.delay.apply(x,[a,1].concat(h.call(arguments,1)))},x.throttle=function(a,b){var c,d,e,f,g,h,i=x.debounce(function(){g=f=!1},b);return function(){c=this,d=arguments;var j=function(){e=null,g&&(h=a.apply(c,d)),i()};return e||(e=setTimeout(j,b)),f?g=!0:(f=!0,h=a.apply(c,d)),i(),h}},x.debounce=function(a,b,c){var d,e;return function(){var f=this,g=arguments,h=function(){d=null,c||(e=a.apply(f,g))},i=c&&!d;return clearTimeout(d),d=setTimeout(h,b),i&&(e=a.apply(f,g)),e}},x.once=function(a){var b,c=!1;return function(){return c?b:(c=!0,b=a.apply(this,arguments),a=null,b)}},x.wrap=function(a,b){return function(){var c=[a];return g.apply(c,arguments),b.apply(this,c)}},x.compose=function(){var a=arguments;return function(){for(var b=arguments,c=a.length-1;c>=0;c--)b=[a[c].apply(this,b)];return b[0]}},x.after=function(a,b){return 0>=a?b():function(){return--a<1?b.apply(this,arguments):void 0}},x.keys=v||function(a){if(a!==Object(a))throw new TypeError("Invalid object");var b=[];for(var c in a)x.has(a,c)&&(b[b.length]=c);return b},x.values=function(a){var b=[];for(var c in a)x.has(a,c)&&b.push(a[c]);return b},x.pairs=function(a){var b=[];for(var c in a)x.has(a,c)&&b.push([c,a[c]]);return b},x.invert=function(a){var b={};for(var c in a)x.has(a,c)&&(b[a[c]]=c);return b},x.functions=x.methods=function(a){var b=[];for(var c in a)x.isFunction(a[c])&&b.push(c);return b.sort()},x.extend=function(a){return y(h.call(arguments,1),function(b){for(var c in b)a[c]=b[c]}),a},x.pick=function(a){var b={},c=i.apply(d,h.call(arguments,1));return y(c,function(c){c in a&&(b[c]=a[c])}),b},x.omit=function(a){var b={},c=i.apply(d,h.call(arguments,1));for(var e in a)x.contains(c,e)||(b[e]=a[e]);return b},x.defaults=function(a){return y(h.call(arguments,1),function(b){for(var c in b)null==a[c]&&(a[c]=b[c])}),a},x.clone=function(a){return x.isObject(a)?x.isArray(a)?a.slice():x.extend({},a):a},x.tap=function(a,b){return b(a),a};var E=function(a,b,c,d){if(a===b)return 0!==a||1/a==1/b;if(null==a||null==b)return a===b;a instanceof x&&(a=a._wrapped),b instanceof x&&(b=b._wrapped);var e=j.call(a);if(e!=j.call(b))return!1;switch(e){case"[object String]":return a==String(b);case"[object Number]":return a!=+a?b!=+b:0==a?1/a==1/b:a==+b;case"[object Date]":case"[object Boolean]":return+a==+b;case"[object RegExp]":return a.source==b.source&&a.global==b.global&&a.multiline==b.multiline&&a.ignoreCase==b.ignoreCase}if("object"!=typeof a||"object"!=typeof b)return!1;for(var f=c.length;f--;)if(c[f]==a)return d[f]==b;c.push(a),d.push(b);var g=0,h=!0;if("[object Array]"==e){if(g=a.length,h=g==b.length)for(;g--&&(h=E(a[g],b[g],c,d)););}else{var i=a.constructor,k=b.constructor;if(i!==k&&!(x.isFunction(i)&&i instanceof i&&x.isFunction(k)&&k instanceof k))return!1;for(var l in a)if(x.has(a,l)&&(g++,!(h=x.has(b,l)&&E(a[l],b[l],c,d))))break;if(h){for(l in b)if(x.has(b,l)&&!g--)break;h=!g}}return c.pop(),d.pop(),h};x.isEqual=function(a,b){return E(a,b,[],[])},x.isEmpty=function(a){if(null==a)return!0;if(x.isArray(a)||x.isString(a))return 0===a.length;for(var b in a)if(x.has(a,b))return!1;return!0},x.isElement=function(a){return!(!a||1!==a.nodeType)},x.isArray=u||function(a){return"[object Array]"==j.call(a)},x.isObject=function(a){return a===Object(a)},y(["Arguments","Function","String","Number","Date","RegExp"],function(a){x["is"+a]=function(b){return j.call(b)=="[object "+a+"]"}}),x.isArguments(arguments)||(x.isArguments=function(a){return!(!a||!x.has(a,"callee"))}),"function"!=typeof/./&&(x.isFunction=function(a){return"function"==typeof a}),x.isFinite=function(a){return x.isNumber(a)&&isFinite(a)},x.isNaN=function(a){return x.isNumber(a)&&a!=+a},x.isBoolean=function(a){return a===!0||a===!1||"[object Boolean]"==j.call(a)},x.isNull=function(a){return null===a},x.isUndefined=function(a){return void 0===a},x.has=function(a,b){return k.call(a,b)},x.noConflict=function(){return a._=b,this},x.identity=function(a){return a},x.times=function(a,b,c){for(var d=0;a>d;d++)b.call(c,d)},x.random=function(a,b){return null==b&&(b=a,a=0),a+(0|Math.random()*(b-a+1))};var F={escape:{"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;","/":"&#x2F;"}};F.unescape=x.invert(F.escape);var G={escape:new RegExp("["+x.keys(F.escape).join("")+"]","g"),unescape:new RegExp("("+x.keys(F.unescape).join("|")+")","g")};x.each(["escape","unescape"],function(a){x[a]=function(b){return null==b?"":(""+b).replace(G[a],function(b){return F[a][b]})}}),x.result=function(a,b){if(null==a)return null;var c=a[b];return x.isFunction(c)?c.call(a):c},x.mixin=function(a){y(x.functions(a),function(b){var c=x[b]=a[b];x.prototype[b]=function(){var a=[this._wrapped];return g.apply(a,arguments),L.call(this,c.apply(x,a))}})};var H=0;x.uniqueId=function(a){var b=H++;return a?a+b:b},x.templateSettings={evaluate:/<%([\s\S]+?)%>/g,interpolate:/<%=([\s\S]+?)%>/g,escape:/<%-([\s\S]+?)%>/g};var I=/(.)^/,J={"'":"'","\\":"\\","\r":"r","\n":"n","	":"t","\u2028":"u2028","\u2029":"u2029"},K=/\\|'|\r|\n|\t|\u2028|\u2029/g;x.template=function(a,b,c){c=x.defaults({},c,x.templateSettings);var d=new RegExp([(c.escape||I).source,(c.interpolate||I).source,(c.evaluate||I).source].join("|")+"|$","g"),e=0,f="__p+='";a.replace(d,function(b,c,d,g,h){f+=a.slice(e,h).replace(K,function(a){return"\\"+J[a]}),f+=c?"'+\n((__t=("+c+"))==null?'':_.escape(__t))+\n'":d?"'+\n((__t=("+d+"))==null?'':__t)+\n'":g?"';\n"+g+"\n__p+='":"",e=h+b.length}),f+="';\n",c.variable||(f="with(obj||{}){\n"+f+"}\n"),f="var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};\n"+f+"return __p;\n";try{var g=new Function(c.variable||"obj","_",f)}catch(h){throw h.source=f,h}if(b)return g(b,x);var i=function(a){return g.call(this,a,x)};return i.source="function("+(c.variable||"obj")+"){\n"+f+"}",i},x.chain=function(a){return x(a).chain()};var L=function(a){return this._chain?x(a).chain():a};x.mixin(x),y(["pop","push","reverse","shift","sort","splice","unshift"],function(a){var b=d[a];x.prototype[a]=function(){var c=this._wrapped;return b.apply(c,arguments),"shift"!=a&&"splice"!=a||0!==c.length||delete c[0],L.call(this,c)}}),y(["concat","join","slice"],function(a){var b=d[a];x.prototype[a]=function(){return L.call(this,b.apply(this._wrapped,arguments))}}),x.extend(x.prototype,{chain:function(){return this._chain=!0,this},value:function(){return this._wrapped}})}.call(this),!function(a,b){"use strict";var c=b.prototype.trim,d=b.prototype.trimRight,e=b.prototype.trimLeft,f=function(a){return 1*a||0},g=function(a,b){if(1>b)return"";for(var c="";b>0;)1&b&&(c+=a),b>>=1,a+=a;return c},h=[].slice,i=function(a){return null==a?"\\s":a.source?a.source:"["+_s.escapeRegExp(a)+"]"},j={lt:"<",gt:">",quot:'"',amp:"&",apos:"'"},k={};for(var l in j)k[j[l]]=l;k["'"]="#39";var m=function(){function a(a){return Object.prototype.toString.call(a).slice(8,-1).toLowerCase()}var c=g,d=function(){return d.cache.hasOwnProperty(arguments[0])||(d.cache[arguments[0]]=d.parse(arguments[0])),d.format.call(null,d.cache[arguments[0]],arguments)};return d.format=function(d,e){var f,g,h,i,j,k,l,n=1,o=d.length,p="",q=[];for(g=0;o>g;g++)if(p=a(d[g]),"string"===p)q.push(d[g]);else if("array"===p){if(i=d[g],i[2])for(f=e[n],h=0;h<i[2].length;h++){if(!f.hasOwnProperty(i[2][h]))throw new Error(m('[_.sprintf] property "%s" does not exist',i[2][h]));f=f[i[2][h]]}else f=i[1]?e[i[1]]:e[n++];if(/[^s]/.test(i[8])&&"number"!=a(f))throw new Error(m("[_.sprintf] expecting number but found %s",a(f)));switch(i[8]){case"b":f=f.toString(2);break;case"c":f=b.fromCharCode(f);break;case"d":f=parseInt(f,10);break;case"e":f=i[7]?f.toExponential(i[7]):f.toExponential();break;case"f":f=i[7]?parseFloat(f).toFixed(i[7]):parseFloat(f);break;case"o":f=f.toString(8);break;case"s":f=(f=b(f))&&i[7]?f.substring(0,i[7]):f;break;case"u":f=Math.abs(f);break;case"x":f=f.toString(16);break;case"X":f=f.toString(16).toUpperCase()}f=/[def]/.test(i[8])&&i[3]&&f>=0?"+"+f:f,k=i[4]?"0"==i[4]?"0":i[4].charAt(1):" ",l=i[6]-b(f).length,j=i[6]?c(k,l):"",q.push(i[5]?f+j:j+f)}return q.join("")},d.cache={},d.parse=function(a){for(var b=a,c=[],d=[],e=0;b;){if(null!==(c=/^[^\x25]+/.exec(b)))d.push(c[0]);else if(null!==(c=/^\x25{2}/.exec(b)))d.push("%");else{if(null===(c=/^\x25(?:([1-9]\d*)\$|\(([^\)]+)\))?(\+)?(0|'[^$])?(-)?(\d+)?(?:\.(\d+))?([b-fosuxX])/.exec(b)))throw new Error("[_.sprintf] huh?");if(c[2]){e|=1;var f=[],g=c[2],h=[];if(null===(h=/^([a-z_][a-z_\d]*)/i.exec(g)))throw new Error("[_.sprintf] huh?");for(f.push(h[1]);""!==(g=g.substring(h[0].length));)if(null!==(h=/^\.([a-z_][a-z_\d]*)/i.exec(g)))f.push(h[1]);else{if(null===(h=/^\[(\d+)\]/.exec(g)))throw new Error("[_.sprintf] huh?");f.push(h[1])}c[2]=f}else e|=2;if(3===e)throw new Error("[_.sprintf] mixing positional and named placeholders is not (yet) supported");d.push(c)}b=b.substring(c[0].length)}return d},d}();window._s={VERSION:"2.3.0",isBlank:function(a){return null==a&&(a=""),/^\s*$/.test(a)},stripTags:function(a){return null==a?"":b(a).replace(/<\/?[^>]+>/g,"")},capitalize:function(a){return a=null==a?"":b(a),a.charAt(0).toUpperCase()+a.slice(1)},chop:function(a,c){return null==a?[]:(a=b(a),c=~~c,c>0?a.match(new RegExp(".{1,"+c+"}","g")):[a])},clean:function(a){return _s.strip(a).replace(/\s+/g," ")},count:function(a,c){if(null==a||null==c)return 0;a=b(a),c=b(c);for(var d=0,e=0,f=c.length;;){if(e=a.indexOf(c,e),-1===e)break;d++,e+=f}return d},chars:function(a){return null==a?[]:b(a).split("")},swapCase:function(a){return null==a?"":b(a).replace(/\S/g,function(a){return a===a.toUpperCase()?a.toLowerCase():a.toUpperCase()})},escapeHTML:function(a){return null==a?"":b(a).replace(/[&<>"']/g,function(a){return"&"+k[a]+";"})},unescapeHTML:function(a){return null==a?"":b(a).replace(/\&([^;]+);/g,function(a,c){var d;return c in j?j[c]:(d=c.match(/^#x([\da-fA-F]+)$/))?b.fromCharCode(parseInt(d[1],16)):(d=c.match(/^#(\d+)$/))?b.fromCharCode(~~d[1]):a})},escapeRegExp:function(a){return null==a?"":b(a).replace(/([.*+?^=!:${}()|[\]\/\\])/g,"\\$1")},splice:function(a,b,c,d){var e=_s.chars(a);return e.splice(~~b,~~c,d),e.join("")},insert:function(a,b,c){return _s.splice(a,b,0,c)},include:function(a,c){return""===c?!0:null==a?!1:-1!==b(a).indexOf(c)},join:function(){var a=h.call(arguments),b=a.shift();return null==b&&(b=""),a.join(b)},lines:function(a){return null==a?[]:b(a).split("\n")},reverse:function(a){return _s.chars(a).reverse().join("")},startsWith:function(a,c){return""===c?!0:null==a||null==c?!1:(a=b(a),c=b(c),a.length>=c.length&&a.slice(0,c.length)===c)},endsWith:function(a,c){return""===c?!0:null==a||null==c?!1:(a=b(a),c=b(c),a.length>=c.length&&a.slice(a.length-c.length)===c)},succ:function(a){return null==a?"":(a=b(a),a.slice(0,-1)+b.fromCharCode(a.charCodeAt(a.length-1)+1))},titleize:function(a){return null==a?"":b(a).replace(/(?:^|\s)\S/g,function(a){return a.toUpperCase()})},camelize:function(a){return _s.trim(a).replace(/[-_\s]+(.)?/g,function(a,b){return b.toUpperCase()})},underscored:function(a){return _s.trim(a).replace(/([a-z\d])([A-Z]+)/g,"$1_$2").replace(/[-\s]+/g,"_").toLowerCase()},dasherize:function(a){return _s.trim(a).replace(/([A-Z])/g,"-$1").replace(/[-_\s]+/g,"-").toLowerCase()},classify:function(a){return _s.titleize(b(a).replace(/_/g," ")).replace(/\s/g,"")},humanize:function(a){return _s.capitalize(_s.underscored(a).replace(/_id$/,"").replace(/_/g," "))},trim:function(a,d){return null==a?"":!d&&c?c.call(a):(d=i(d),b(a).replace(new RegExp("^"+d+"+|"+d+"+$","g"),""))},ltrim:function(a,c){return null==a?"":!c&&e?e.call(a):(c=i(c),b(a).replace(new RegExp("^"+c+"+"),""))},rtrim:function(a,c){return null==a?"":!c&&d?d.call(a):(c=i(c),b(a).replace(new RegExp(c+"+$"),""))},truncate:function(a,c,d){return null==a?"":(a=b(a),d=d||"...",c=~~c,a.length>c?a.slice(0,c)+d:a)},prune:function(a,c,d){if(null==a)return"";if(a=b(a),c=~~c,d=null!=d?b(d):"...",a.length<=c)return a;var e=function(a){return a.toUpperCase()!==a.toLowerCase()?"A":" "},f=a.slice(0,c+1).replace(/.(?=\W*\w*$)/g,e);return f=f.slice(f.length-2).match(/\w\w/)?f.replace(/\s*\S+$/,""):_s.rtrim(f.slice(0,f.length-1)),(f+d).length>a.length?a:a.slice(0,f.length)+d},words:function(a,b){return _s.isBlank(a)?[]:_s.trim(a,b).split(b||/\s+/)},pad:function(a,c,d,e){a=null==a?"":b(a),c=~~c;var f=0;switch(d?d.length>1&&(d=d.charAt(0)):d=" ",e){case"right":return f=c-a.length,a+g(d,f);case"both":return f=c-a.length,g(d,Math.ceil(f/2))+a+g(d,Math.floor(f/2));default:return f=c-a.length,g(d,f)+a}},lpad:function(a,b,c){return _s.pad(a,b,c)},rpad:function(a,b,c){return _s.pad(a,b,c,"right")},lrpad:function(a,b,c){return _s.pad(a,b,c,"both")},sprintf:m,vsprintf:function(a,b){return b.unshift(a),m.apply(null,b)},toNumber:function(a,b){return a?(a=_s.trim(a),a.match(/^-?\d+(?:\.\d+)?$/)?f(f(a).toFixed(~~b)):0/0):0},numberFormat:function(a,b,c,d){if(isNaN(a)||null==a)return"";a=a.toFixed(~~b),d="string"==typeof d?d:",";var e=a.split("."),f=e[0],g=e[1]?(c||".")+e[1]:"";return f.replace(/(\d)(?=(?:\d{3})+$)/g,"$1"+d)+g},strRight:function(a,c){if(null==a)return"";a=b(a),c=null!=c?b(c):c;var d=c?a.indexOf(c):-1;return~d?a.slice(d+c.length,a.length):a},strRightBack:function(a,c){if(null==a)return"";a=b(a),c=null!=c?b(c):c;var d=c?a.lastIndexOf(c):-1;return~d?a.slice(d+c.length,a.length):a},strLeft:function(a,c){if(null==a)return"";a=b(a),c=null!=c?b(c):c;var d=c?a.indexOf(c):-1;return~d?a.slice(0,d):a},strLeftBack:function(a,b){if(null==a)return"";a+="",b=null!=b?""+b:b;var c=a.lastIndexOf(b);return~c?a.slice(0,c):a},toSentence:function(a,b,c,d){b=b||", ",c=c||" and ";var e=a.slice(),f=e.pop();return a.length>2&&d&&(c=_s.rtrim(b)+c),e.length?e.join(b)+c+f:f},toSentenceSerial:function(){var a=h.call(arguments);return a[3]=!0,_s.toSentence.apply(_s,a)},slugify:function(a){if(null==a)return"";var c="ąàáäâãåæćęèéëêìíïîłńòóöôõøùúüûñçżź",d="aaaaaaaaceeeeeiiiilnoooooouuuunczz",e=new RegExp(i(c),"g");return a=b(a).toLowerCase().replace(e,function(a){var b=c.indexOf(a);return d.charAt(b)||"-"}),_s.dasherize(a.replace(/[^\w\s-]/g,""))},surround:function(a,b){return[b,a,b].join("")},quote:function(a){return _s.surround(a,'"')},exports:function(){var a={};for(var b in this)this.hasOwnProperty(b)&&!b.match(/^(?:include|contains|reverse)$/)&&(a[b]=this[b]);return a},repeat:function(a,c,d){if(null==a)return"";
if(c=~~c,null==d)return g(b(a),c);for(var e=[];c>0;e[--c]=a);return e.join(d)},levenshtein:function(a,c){if(null==a&&null==c)return 0;if(null==a)return b(c).length;if(null==c)return b(a).length;a=b(a),c=b(c);for(var d,e,f=[],g=0;g<=c.length;g++)for(var h=0;h<=a.length;h++)e=g&&h?a.charAt(h-1)===c.charAt(g-1)?d:Math.min(f[h],f[h-1],d)+1:g+h,d=f[h],f[h]=e;return f.pop()}},_s.strip=_s.trim,_s.lstrip=_s.ltrim,_s.rstrip=_s.rtrim,_s.center=_s.lrpad,_s.rjust=_s.lpad,_s.ljust=_s.rpad,_s.contains=_s.include,_s.q=_s.quote,"undefined"!=typeof exports&&("undefined"!=typeof module&&module.exports&&(module.exports=_s),exports._s=_s),"function"==typeof define&&define.amd&&define("underscore.string",[],function(){return _s}),a._=a._||{},a._.string=a._.str=_s}(this,String),helpers={parseyear:function(a){return a.substr(0,4)},localStorageSafety:function(a){(null==localStorage[a]||void 0==localStorage[a]||"undefined"==localStorage[a])&&(localStorage[a]="[]")},localStorageSafetyObject:function(a){(null==localStorage[a]||void 0==localStorage[a]||"undefined"==localStorage[a])&&(localStorage[a]="{}")},getLocalStorage:function(a){return this.localStorageSafety(a),JSON.parse(localStorage[a])},addToLocalStorage:function(a,b,c){this.localStorageSafety(a);var d=this.getLocalStorage(a);return c?d.unshift(b):d.push(b),"history"==a&&(d=_.last(d,50)),localStorage[a]=JSON.stringify(d),this.getLocalStorage(a)},clearLocalStorage:function(a){return localStorage[a]="[]",this.getLocalStorage(a)},parseDOM:function(a){var b=a instanceof HTMLElement?a.dataset:a;return b&&(b.id=parseFloat(b.id)),b},parsetime:function(a){var b=a>5e3?1e3:1,c=Math.round(a/b),d=Math.floor(c/60),e=c-60*d;return 10>e&&(e="0"+e),d+":"+e},slugify:function(a){if(null==a)return"";var b="ąàáäâãåæćęèéëêìíïîłńòóöôõøśùúüûñçżź",c="aaaaaaaaceeeeeiiiilnoooooosuuuunczz",d=new RegExp(helpers.defaultToWhiteSpace(b),"g");return a=String(a).toLowerCase().replace(d,function(a){var d=b.indexOf(a);return c.charAt(d)||"-"}),_s.dasherize(a.replace(/[^\w\s-]/g,""))},defaultToWhiteSpace:function(a){return null==a?"\\s":a.source?a.source:"["+helpers.escapeRegExp(a)+"]"},escapeRegExp:function(a){return null==a?"":String(a).replace(/([.*+?^=!:${}()|[\]\/\\])/g,"\\$1")},parseYTId:function(a){return void 0==a?null:a.id.$t.substr(-11)},createID:function(a){for(var b="",c="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",d=0;a>d;d++)b+=c.charAt(Math.floor(Math.random()*c.length));return b},getHQAlbumImage:function(a,b){var c=a.image;return c?b?c.replace("100x100-75.jpg",b+"x"+b+"-75.jpg"):c:"data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw=="},coverArrayToHQ:function(a,b){var c=[];for(i=0;i<a.length;i++)c.push(helpers.getHQAlbumImage({image:a[i]},b));return c},parsetext:function(a){var a=a+"",b=-1!=a.indexOf("(")?'<span class="lighttext">'+a.substr(a.indexOf("(")).substr(1).replace(")","")+"</span>":"",c=-1!=a.indexOf("(")?a.substr(0,a.indexOf("(")):a;return c+b},parsehours:function(a){var b,c=a/1e3;return b=10>c?"a few seconds":50>c?10*Math.round(c/10)+" seconds":90>c?"one minute":3600>c?Math.round(c/60)+" minutes":c>=3600?Math.round(c/360)/10+" hours":"Unknown length"},albumRelevance:function(a,b){var c=b,d=[{word:"remix",reason:"This album only contains Remixes of one song:"},{word:"instrumental",reason:"This is is the Instrumental version of"},{word:"- ep",reason:"This album may contain duplicate tracks:"},{word:"acoustic",reason:"This album is an acoustic version:"},{word:"itunes",reason:"This album is an iTunes version:"},{word:"live",reason:"This is a live album:"},{word:"karaoke",reason:"This is a karaoke/instrumental version: "}];return c.each(d,function(b){-1!=(a.name+"").toLowerCase().indexOf(b.word)&&(a.hidden=b.reason)}),a.tracks>30&&(a.hidden="This album is very long ("+a.tracks+" tracks):"),a},parseAlbumTitle:function(a){var b=a.name+"",c=b.substr(0,-1==b.indexOf("(")?b.length:b.indexOf("(")-1),d=/\(([^()]+)\)/g,e=b.match(d),f=e?e[0].substr(1,e[0].length-2):null;return a.name=c,a.subtitle=f,a},sortTracks:function(a,b){var c=[];return _.each(a,function(a){var d=_.find(b,function(b){return b.id==a});d&&c.push(d)}),c},makeAlbum:function(a,b){return{id:a.album.collectionId,tracks:a.songs.length,artist:a.album.artistName,artistid:a.album.artistId,release:a.album.releaseDate,image:a.album.artworkUrl100,name:a.album.collectionName,hours:b.reduce(b.pluck(a.songs,"duration"),function(a,b){return a+parseFloat(b)},0)}},parseReleaseLeft:function(a){var b=new Date(a);if("Invalid Date"==b)return"";var c=b-new Date,d=c/1e3;if(3600>d)return"Album will be released within 1 hour";var e=d/3600;if(24>e)return"Album will be available in "+Math.floor(e)+" hours";var f=Math.floor(e/24);return 1==f?"Album will be available tomorrow":"Album will be available in  days"},titleMatcher:function(a,b){return b.chain(a.toLowerCase().split(/[.&()\[\]\-\s]/g)).compact().without("ft","feat","lyric","lyrics","official","hd","music","audio","hq","video")._wrapped}},this.helpers=helpers,views={artist:{load:function(a){$.ajax({url:"/api/artist/"+a,dataType:"html",success:function(a){$("#view").html(a),views.loadingindicator.hide(),$.publish("new-tracks-entered-dom"),$.publish("view-got-loaded")},error:function(){errors.draw(404)}})}},song:{load:function(a){$.ajax({url:"/api/song/"+a,dataType:"html",success:function(a){$("#view").html(a),$.publish("new-tracks-entered-dom"),views.loadingindicator.hide(),$.publish("view-got-loaded")}})}},album:{load:function(a){$.ajax({url:"/api/album/"+a,dataType:"html",success:function(a){var b=$("#view");b.html(a),views.loadingindicator.hide(),$.publish("new-tracks-entered-dom"),$.publish("view-got-loaded")},error:function(){errors.draw(404)}})}},track:{load:function(a){$.ajax({url:"/api/track/"+a,dataType:"html",success:function(a){var b=$("#view");b.html(a),views.loadingindicator.hide(),$.publish("view-got-loaded")},error:function(){errors.draw(404)}})}},charts:{load:function(){$.ajax({url:"/api/charts",dataType:"html",success:function(a){var b=$("#view");b.html(a),views.loadingindicator.hide(),$.publish("new-tracks-entered-dom"),$.publish("view-got-loaded")},error:function(){errors.draw(404)}})}},retrocharts:{load:function(a){$.ajax({url:"/api/charts/"+a,dataType:"html",success:function(a){var b=$("#view");b.html(a),views.loadingindicator.hide(),$.publish("new-tracks-entered-dom"),$.publish("view-got-loaded")}})}},info:{load:function(){$.ajax({url:"/api/info",dataType:"html",success:function(a){var b=$("#view");b.html(a),views.loadingindicator.hide(),$.publish("view-got-loaded")},error:function(){errors.draw(404)}})}},loadingindicator:{hide:function(){$("#loading-indicator").removeClass("loading-indicator-visible")}},library:{load:function(){var a=chinchilla.library,b={user:chinchilla.loggedin},c=function(b){var c=b,e=_.difference(a,_.pluck(c,"id"));0!=e.length?(socket.emit("/api/tracks/get",{tracks:e}),socket.on("/api/tracks/get/response",function(a){var b=_.union(a,c);d(b),_.each(a,function(a){DB.addTrack(a)})})):d(c)},d=function(c){b.tracks=helpers.sortTracks(a,c).reverse();var d=templates.buildLibrary(b);$("#view").html(d).scrollTop(0),views.loadingindicator.hide(),$.publish("new-tracks-entered-dom"),$.publish("view-got-loaded")};DB.getTracks({ids:a,callback:c})}},playlist:{load:function(a){var b=_.where(chinchilla.playlists,{url:a})[0],c={user:chinchilla.loggedin,playlist:b},d=function(a){var c=a,d=_.difference(b.tracks,_.pluck(c,"id"));0!=d.length?(socket.emit("/api/tracks/get",{tracks:d}),socket.on("/api/tracks/get/response",function(a){var b=_.union(a,c),d=_.map(b,function(a){return a.inlib=_.contains(chinchilla.library,a.id),a});e(d),_.each(a,function(a){DB.addTrack(a)})})):e(c)},e=function(a){c.tracks=helpers.sortTracks(b.tracks,a),b.newestattop&&(c.tracks=c.tracks.reverse());var d=templates.buildPlaylist(c);$("#view").html(d).scrollTop(0),views.loadingindicator.hide(),$.publish("new-tracks-entered-dom"),$.publish("view-got-loaded")};b?DB.getTracks({ids:b.tracks,callback:d}):(socket.emit("/api/playlists/get-tracks",{playlist:a,token:chinchilla.token}),socket.on("/api/playlists/get-tracks/response",function(a){a.error?$.ajax({url:"/api/error/502",dataType:"html",success:function(a){var b=$("#view");b.html(a),views.loadingindicator.hide(),$.publish("view-got-loaded")}}):(b=a.playlist,c.playlist=a.playlist,chinchilla.playlists=[b],DB.getTracks({ids:a.playlist.tracks,callback:d}))}))}},lyrics:{load:function(a){$.ajax({url:"/api/lyrics/"+a,dataType:"html",success:function(a){var b=$("#view");b.html(a),views.loadingindicator.hide(),$.publish("view-got-loaded")}})}},redditpl:{load:function(a){$.ajax({url:"/api/thread/"+a,dataType:"html",success:function(a){var b=$("#view");b.html(a),views.loadingindicator.hide(),$.publish("view-got-loaded"),$.publish("new-tracks-entered-dom")}})}},reddit:{load:function(){$.ajax({url:"/api/reddit",dataType:"html",success:function(a){var b=$("#view");b.html(a),views.loadingindicator.hide(),$.publish("new-tracks-entered-dom"),$.publish("view-got-loaded")},error:function(){errors.draw(404)}})}},settings:{get:function(){$.ajax({url:"/api/settings",dataType:"html",success:function(a){$("#view").html(a),views.loadingindicator.hide(),$.publish("view-got-loaded")},error:function(){errors.draw(404)}})}},main:{get:function(){$.ajax({url:"/api/main",dataType:"html",success:function(a){$("#view").html(a),views.loadingindicator.hide(),$.publish("new-tracks-entered-dom"),$.publish("view-got-loaded")},error:function(){errors.draw(404)}})}},remote:{get:function(){$.ajax({url:"/api/remote",dataType:"html",success:function(a){$("#view").html(a),views.loadingindicator.hide(),$.publish("view-got-loaded")},error:function(){errors.draw(404)}})}}},routes={"/charts":function(){views.charts.load()},"/album/:id":function(a){views.album.load(a[1])},"/about":function(){views.about.load()},"/track/:id":function(a){views.track.load(a[1])},"/register":function(){registration.facebook.load()},"/library":function(a){views.library.load(a[1])},settings:function(){views.settings.get()},"/home":function(){views.main.get()},"/artist/:id":function(a){views.artist.load(a[1])},"/lyrics/:id":function(a){views.lyrics.load(a[1])},"/u/:name/p/:name":function(a){views.playlist.load(a[0]),$("#drop-target-label").text("this playlist")},"/thread/:name":function(a){views.redditpl.load(a[1])},"/reddit":function(){views.reddit.load()},"/":function(){navigation.to("/home")},"/song/:id":function(a){views.song.load(a[1])},"/retro-charts/:id":function(a){views.retrocharts.load(a[1])},"/logout":function(){window.location="/logout"},"/login":function(){window.location="/auth/facebook"},"/info":function(){views.info.load()},"/remote":function(){views.remote.get()},"/youtube":function(){showYouTubePage()},"/import":function(){showImportPage(),views.loadingindicator.hide()}},$(document).on("ready",function(){var a=window.location.pathname;navigation.to(a)}).on("mousedown","[data-navigate]",function(a){if(2!=a.button){var b=$(this).attr("data-navigate");a.preventDefault(),navigation.to(b)}});var showSpinner=function(){$("#loading-indicator").addClass("loading-indicator-visible")};loader={spinner:function(){return'<div class="loading-indicator"><div class="spinner"></div></div>'}},navigation={to:function(a,b){var c="menuselected";$("."+c).removeClass(c),$("#sidebar").find('[data-navigate="'+a+'"]').addClass(c);var d={path:a,timestamp:Date.now()},e=d.timestamp-window.currentroute.timestamp,f=d.path==window.currentroute.path;(e>3e3||!f)&&(window.currentroute=d,$.each(routes,function(c,d){var e=new RegExp(c.replace(/:[name]+/g,"([\\a-z0-9-.]+)").replace(/:[id]+/g,"([\\d]+)")),f=a.match(e);if(f&&"/"!=f||"/"==f&&"/"==a){$("#drop-target-label").text("your library"),hideYouTubePage(),d(f),showSpinner(),$.publish("view-gets-loaded");var g=b?"replaceState":"pushState";history[g](null,null,a),$("#view").attr("data-route",a).scrollTop(0)}}))}},window.onpopstate=function(){var a=window.location.pathname;document.getElementById("view").dataset.route!=a&&navigation.to(a,!0)},window.currentroute={path:"",timestamp:Date.now()};var io="undefined"==typeof module?{}:module.exports;!function(){!function(a,b){var c=a;c.version="0.9.11",c.protocol=1,c.transports=[],c.j=[],c.sockets={},c.connect=function(a,d){var e,f,g=c.util.parseUri(a);b&&b.location&&(g.protocol=g.protocol||b.location.protocol.slice(0,-1),g.host=g.host||(b.document?b.document.domain:b.location.hostname),g.port=g.port||b.location.port),e=c.util.uniqueUri(g);var h={host:g.host,secure:"https"==g.protocol,port:g.port||("https"==g.protocol?443:80),query:g.query||""};return c.util.merge(h,d),(h["force new connection"]||!c.sockets[e])&&(f=new c.Socket(h)),!h["force new connection"]&&f&&(c.sockets[e]=f),f=f||c.sockets[e],f.of(g.path.length>1?g.path:"")}}("object"==typeof module?module.exports:this.io={},this),function(a,b){var c=a.util={},d=/^(?:(?![^:@]+:[^:@\/]*@)([^:\/?#.]+):)?(?:\/\/)?((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/,e=["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","anchor"];c.parseUri=function(a){for(var b=d.exec(a||""),c={},f=14;f--;)c[e[f]]=b[f]||"";return c},c.uniqueUri=function(a){var c=a.protocol,d=a.host,e=a.port;return"document"in b?(d=d||document.domain,e=e||("https"==c&&"https:"!==document.location.protocol?443:document.location.port)):(d=d||"localhost",e||"https"!=c||(e=443)),(c||"http")+"://"+d+":"+(e||80)},c.query=function(a,b){var d=c.chunkQuery(a||""),e=[];c.merge(d,c.chunkQuery(b||""));for(var f in d)d.hasOwnProperty(f)&&e.push(f+"="+d[f]);return e.length?"?"+e.join("&"):""},c.chunkQuery=function(a){for(var b,c={},d=a.split("&"),e=0,f=d.length;f>e;++e)b=d[e].split("="),b[0]&&(c[b[0]]=b[1]);return c};var f=!1;c.load=function(a){return"document"in b&&"complete"===document.readyState||f?a():(c.on(b,"load",a,!1),void 0)},c.on=function(a,b,c,d){a.attachEvent?a.attachEvent("on"+b,c):a.addEventListener&&a.addEventListener(b,c,d)},c.request=function(a){if(a&&"undefined"!=typeof XDomainRequest&&!c.ua.hasCORS)return new XDomainRequest;if("undefined"!=typeof XMLHttpRequest&&(!a||c.ua.hasCORS))return new XMLHttpRequest;if(!a)try{return new(window[["Active"].concat("Object").join("X")])("Microsoft.XMLHTTP")}catch(b){}return null},"undefined"!=typeof window&&c.load(function(){f=!0}),c.defer=function(a){return c.ua.webkit&&"undefined"==typeof importScripts?(c.load(function(){setTimeout(a,100)}),void 0):a()},c.merge=function(a,b,d,e){var f,g=e||[],h="undefined"==typeof d?2:d;for(f in b)b.hasOwnProperty(f)&&c.indexOf(g,f)<0&&("object"==typeof a[f]&&h?c.merge(a[f],b[f],h-1,g):(a[f]=b[f],g.push(b[f])));return a},c.mixin=function(a,b){c.merge(a.prototype,b.prototype)},c.inherit=function(a,b){function c(){}c.prototype=b.prototype,a.prototype=new c},c.isArray=Array.isArray||function(a){return"[object Array]"===Object.prototype.toString.call(a)},c.intersect=function(a,b){for(var d=[],e=a.length>b.length?a:b,f=a.length>b.length?b:a,g=0,h=f.length;h>g;g++)~c.indexOf(e,f[g])&&d.push(f[g]);return d},c.indexOf=function(a,b,c){for(var d=a.length,c=0>c?0>c+d?0:c+d:c||0;d>c&&a[c]!==b;c++);return c>=d?-1:c},c.toArray=function(a){for(var b=[],c=0,d=a.length;d>c;c++)b.push(a[c]);return b},c.ua={},c.ua.hasCORS="undefined"!=typeof XMLHttpRequest&&function(){try{var a=new XMLHttpRequest}catch(b){return!1}return void 0!=a.withCredentials}(),c.ua.webkit="undefined"!=typeof navigator&&/webkit/i.test(navigator.userAgent),c.ua.iDevice="undefined"!=typeof navigator&&/iPad|iPhone|iPod/i.test(navigator.userAgent)}("undefined"!=typeof io?io:module.exports,this),function(a,b){function c(){}a.EventEmitter=c,c.prototype.on=function(a,c){return this.$events||(this.$events={}),this.$events[a]?b.util.isArray(this.$events[a])?this.$events[a].push(c):this.$events[a]=[this.$events[a],c]:this.$events[a]=c,this},c.prototype.addListener=c.prototype.on,c.prototype.once=function(a,b){function c(){d.removeListener(a,c),b.apply(this,arguments)}var d=this;return c.listener=b,this.on(a,c),this},c.prototype.removeListener=function(a,c){if(this.$events&&this.$events[a]){var d=this.$events[a];if(b.util.isArray(d)){for(var e=-1,f=0,g=d.length;g>f;f++)if(d[f]===c||d[f].listener&&d[f].listener===c){e=f;break}if(0>e)return this;d.splice(e,1),d.length||delete this.$events[a]}else(d===c||d.listener&&d.listener===c)&&delete this.$events[a]}return this},c.prototype.removeAllListeners=function(a){return void 0===a?(this.$events={},this):(this.$events&&this.$events[a]&&(this.$events[a]=null),this)},c.prototype.listeners=function(a){return this.$events||(this.$events={}),this.$events[a]||(this.$events[a]=[]),b.util.isArray(this.$events[a])||(this.$events[a]=[this.$events[a]]),this.$events[a]},c.prototype.emit=function(a){if(!this.$events)return!1;var c=this.$events[a];if(!c)return!1;var d=Array.prototype.slice.call(arguments,1);if("function"==typeof c)c.apply(this,d);else{if(!b.util.isArray(c))return!1;for(var e=c.slice(),f=0,g=e.length;g>f;f++)e[f].apply(this,d)}return!0}}("undefined"!=typeof io?io:module.exports,"undefined"!=typeof io?io:module.parent.exports),function(exports,nativeJSON){"use strict";function f(a){return 10>a?"0"+a:a}function date(a){return isFinite(a.valueOf())?a.getUTCFullYear()+"-"+f(a.getUTCMonth()+1)+"-"+f(a.getUTCDate())+"T"+f(a.getUTCHours())+":"+f(a.getUTCMinutes())+":"+f(a.getUTCSeconds())+"Z":null}function quote(a){return escapable.lastIndex=0,escapable.test(a)?'"'+a.replace(escapable,function(a){var b=meta[a];return"string"==typeof b?b:"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4)})+'"':'"'+a+'"'}function str(a,b){var c,d,e,f,g,h=gap,i=b[a];switch(i instanceof Date&&(i=date(a)),"function"==typeof rep&&(i=rep.call(b,a,i)),typeof i){case"string":return quote(i);case"number":return isFinite(i)?String(i):"null";case"boolean":case"null":return String(i);case"object":if(!i)return"null";if(gap+=indent,g=[],"[object Array]"===Object.prototype.toString.apply(i)){for(f=i.length,c=0;f>c;c+=1)g[c]=str(c,i)||"null";return e=0===g.length?"[]":gap?"[\n"+gap+g.join(",\n"+gap)+"\n"+h+"]":"["+g.join(",")+"]",gap=h,e}if(rep&&"object"==typeof rep)for(f=rep.length,c=0;f>c;c+=1)"string"==typeof rep[c]&&(d=rep[c],e=str(d,i),e&&g.push(quote(d)+(gap?": ":":")+e));else for(d in i)Object.prototype.hasOwnProperty.call(i,d)&&(e=str(d,i),e&&g.push(quote(d)+(gap?": ":":")+e));return e=0===g.length?"{}":gap?"{\n"+gap+g.join(",\n"+gap)+"\n"+h+"}":"{"+g.join(",")+"}",gap=h,e}}if(nativeJSON&&nativeJSON.parse)return exports.JSON={parse:nativeJSON.parse,stringify:nativeJSON.stringify};var JSON=exports.JSON={},cx=/[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,escapable=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,gap,indent,meta={"\b":"\\b","	":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"},rep;JSON.stringify=function(a,b,c){var d;if(gap="",indent="","number"==typeof c)for(d=0;c>d;d+=1)indent+=" ";else"string"==typeof c&&(indent=c);if(rep=b,b&&"function"!=typeof b&&("object"!=typeof b||"number"!=typeof b.length))throw new Error("JSON.stringify");return str("",{"":a})},JSON.parse=function(text,reviver){function walk(a,b){var c,d,e=a[b];if(e&&"object"==typeof e)for(c in e)Object.prototype.hasOwnProperty.call(e,c)&&(d=walk(e,c),void 0!==d?e[c]=d:delete e[c]);return reviver.call(a,b,e)}var j;if(text=String(text),cx.lastIndex=0,cx.test(text)&&(text=text.replace(cx,function(a){return"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4)})),/^[\],:{}\s]*$/.test(text.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,"@").replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,"]").replace(/(?:^|:|,)(?:\s*\[)+/g,"")))return j=eval("("+text+")"),"function"==typeof reviver?walk({"":j},""):j;throw new SyntaxError("JSON.parse")}}("undefined"!=typeof io?io:module.exports,"undefined"!=typeof JSON?JSON:void 0),function(a,b){var c=a.parser={},d=c.packets=["disconnect","connect","heartbeat","message","json","event","ack","error","noop"],e=c.reasons=["transport not supported","client not handshaken","unauthorized"],f=c.advice=["reconnect"],g=b.JSON,h=b.util.indexOf;c.encodePacket=function(a){var b=h(d,a.type),c=a.id||"",i=a.endpoint||"",j=a.ack,k=null;switch(a.type){case"error":var l=a.reason?h(e,a.reason):"",m=a.advice?h(f,a.advice):"";(""!==l||""!==m)&&(k=l+(""!==m?"+"+m:""));break;case"message":""!==a.data&&(k=a.data);break;case"event":var n={name:a.name};a.args&&a.args.length&&(n.args=a.args),k=g.stringify(n);break;case"json":k=g.stringify(a.data);break;case"connect":a.qs&&(k=a.qs);break;case"ack":k=a.ackId+(a.args&&a.args.length?"+"+g.stringify(a.args):"")}var o=[b,c+("data"==j?"+":""),i];return null!==k&&void 0!==k&&o.push(k),o.join(":")},c.encodePayload=function(a){var b="";if(1==a.length)return a[0];for(var c=0,d=a.length;d>c;c++){var e=a[c];b+="�"+e.length+"�"+a[c]}return b};var i=/([^:]+):([0-9]+)?(\+)?:([^:]+)?:?([\s\S]*)?/;c.decodePacket=function(a){var b=a.match(i);if(!b)return{};var c=b[2]||"",a=b[5]||"",h={type:d[b[1]],endpoint:b[4]||""};switch(c&&(h.id=c,h.ack=b[3]?"data":!0),h.type){case"error":var b=a.split("+");h.reason=e[b[0]]||"",h.advice=f[b[1]]||"";break;case"message":h.data=a||"";break;case"event":try{var j=g.parse(a);h.name=j.name,h.args=j.args}catch(k){}h.args=h.args||[];break;case"json":try{h.data=g.parse(a)}catch(k){}break;case"connect":h.qs=a||"";break;case"ack":var b=a.match(/^([0-9]+)(\+)?(.*)/);if(b&&(h.ackId=b[1],h.args=[],b[3]))try{h.args=b[3]?g.parse(b[3]):[]}catch(k){}break;case"disconnect":case"heartbeat":}return h},c.decodePayload=function(a){if("�"==a.charAt(0)){for(var b=[],d=1,e="";d<a.length;d++)"�"==a.charAt(d)?(b.push(c.decodePacket(a.substr(d+1).substr(0,e))),d+=Number(e)+1,e=""):e+=a.charAt(d);return b}return[c.decodePacket(a)]}}("undefined"!=typeof io?io:module.exports,"undefined"!=typeof io?io:module.parent.exports),function(a,b){function c(a,b){this.socket=a,this.sessid=b}a.Transport=c,b.util.mixin(c,b.EventEmitter),c.prototype.heartbeats=function(){return!0},c.prototype.onData=function(a){if(this.clearCloseTimeout(),(this.socket.connected||this.socket.connecting||this.socket.reconnecting)&&this.setCloseTimeout(),""!==a){var c=b.parser.decodePayload(a);if(c&&c.length)for(var d=0,e=c.length;e>d;d++)this.onPacket(c[d])}return this},c.prototype.onPacket=function(a){return this.socket.setHeartbeatTimeout(),"heartbeat"==a.type?this.onHeartbeat():("connect"==a.type&&""==a.endpoint&&this.onConnect(),"error"==a.type&&"reconnect"==a.advice&&(this.isOpen=!1),this.socket.onPacket(a),this)},c.prototype.setCloseTimeout=function(){if(!this.closeTimeout){var a=this;this.closeTimeout=setTimeout(function(){a.onDisconnect()},this.socket.closeTimeout)}},c.prototype.onDisconnect=function(){return this.isOpen&&this.close(),this.clearTimeouts(),this.socket.onDisconnect(),this},c.prototype.onConnect=function(){return this.socket.onConnect(),this},c.prototype.clearCloseTimeout=function(){this.closeTimeout&&(clearTimeout(this.closeTimeout),this.closeTimeout=null)},c.prototype.clearTimeouts=function(){this.clearCloseTimeout(),this.reopenTimeout&&clearTimeout(this.reopenTimeout)},c.prototype.packet=function(a){this.send(b.parser.encodePacket(a))},c.prototype.onHeartbeat=function(){this.packet({type:"heartbeat"})},c.prototype.onOpen=function(){this.isOpen=!0,this.clearCloseTimeout(),this.socket.onOpen()},c.prototype.onClose=function(){this.isOpen=!1,this.socket.onClose(),this.onDisconnect()},c.prototype.prepareUrl=function(){var a=this.socket.options;return this.scheme()+"://"+a.host+":"+a.port+"/"+a.resource+"/"+b.protocol+"/"+this.name+"/"+this.sessid},c.prototype.ready=function(a,b){b.call(this)}}("undefined"!=typeof io?io:module.exports,"undefined"!=typeof io?io:module.parent.exports),function(a,b,c){function d(a){if(this.options={port:80,secure:!1,document:"document"in c?document:!1,resource:"socket.io",transports:b.transports,"connect timeout":1e4,"try multiple transports":!0,reconnect:!0,"reconnection delay":500,"reconnection limit":1/0,"reopen delay":3e3,"max reconnection attempts":10,"sync disconnect on unload":!1,"auto connect":!0,"flash policy port":10843,manualFlush:!1},b.util.merge(this.options,a),this.connected=!1,this.open=!1,this.connecting=!1,this.reconnecting=!1,this.namespaces={},this.buffer=[],this.doBuffer=!1,this.options["sync disconnect on unload"]&&(!this.isXDomain()||b.util.ua.hasCORS)){var d=this;b.util.on(c,"beforeunload",function(){d.disconnectSync()},!1)}this.options["auto connect"]&&this.connect()}function e(){}a.Socket=d,b.util.mixin(d,b.EventEmitter),d.prototype.of=function(a){return this.namespaces[a]||(this.namespaces[a]=new b.SocketNamespace(this,a),""!==a&&this.namespaces[a].packet({type:"connect"})),this.namespaces[a]},d.prototype.publish=function(){this.emit.apply(this,arguments);var a;for(var b in this.namespaces)this.namespaces.hasOwnProperty(b)&&(a=this.of(b),a.$emit.apply(a,arguments))},d.prototype.handshake=function(a){function c(b){b instanceof Error?(d.connecting=!1,d.onError(b.message)):a.apply(null,b.split(":"))}var d=this,f=this.options,g=["http"+(f.secure?"s":"")+":/",f.host+":"+f.port,f.resource,b.protocol,b.util.query(this.options.query,"t="+ +new Date)].join("/");if(this.isXDomain()&&!b.util.ua.hasCORS){var h=document.getElementsByTagName("script")[0],i=document.createElement("script");i.src=g+"&jsonp="+b.j.length,h.parentNode.insertBefore(i,h),b.j.push(function(a){c(a),i.parentNode.removeChild(i)})}else{var j=b.util.request();j.open("GET",g,!0),this.isXDomain()&&(j.withCredentials=!0),j.onreadystatechange=function(){4==j.readyState&&(j.onreadystatechange=e,200==j.status?c(j.responseText):403==j.status?d.onError(j.responseText):(d.connecting=!1,!d.reconnecting&&d.onError(j.responseText)))},j.send(null)}},d.prototype.getTransport=function(a){for(var c,d=a||this.transports,e=0;c=d[e];e++)if(b.Transport[c]&&b.Transport[c].check(this)&&(!this.isXDomain()||b.Transport[c].xdomainCheck(this)))return new b.Transport[c](this,this.sessionid);return null},d.prototype.connect=function(a){if(this.connecting)return this;var c=this;return c.connecting=!0,this.handshake(function(d,e,f,g){function h(a){return c.transport&&c.transport.clearTimeouts(),c.transport=c.getTransport(a),c.transport?(c.transport.ready(c,function(){c.connecting=!0,c.publish("connecting",c.transport.name),c.transport.open(),c.options["connect timeout"]&&(c.connectTimeoutTimer=setTimeout(function(){if(!c.connected&&(c.connecting=!1,c.options["try multiple transports"])){for(var a=c.transports;a.length>0&&a.splice(0,1)[0]!=c.transport.name;);a.length?h(a):c.publish("connect_failed")}},c.options["connect timeout"]))}),void 0):c.publish("connect_failed")}c.sessionid=d,c.closeTimeout=1e3*f,c.heartbeatTimeout=1e3*e,c.transports||(c.transports=c.origTransports=g?b.util.intersect(g.split(","),c.options.transports):c.options.transports),c.setHeartbeatTimeout(),h(c.transports),c.once("connect",function(){clearTimeout(c.connectTimeoutTimer),a&&"function"==typeof a&&a()})}),this},d.prototype.setHeartbeatTimeout=function(){if(clearTimeout(this.heartbeatTimeoutTimer),!this.transport||this.transport.heartbeats()){var a=this;this.heartbeatTimeoutTimer=setTimeout(function(){a.transport.onClose()},this.heartbeatTimeout)}},d.prototype.packet=function(a){return this.connected&&!this.doBuffer?this.transport.packet(a):this.buffer.push(a),this},d.prototype.setBuffer=function(a){this.doBuffer=a,!a&&this.connected&&this.buffer.length&&(this.options.manualFlush||this.flushBuffer())},d.prototype.flushBuffer=function(){this.transport.payload(this.buffer),this.buffer=[]},d.prototype.disconnect=function(){return(this.connected||this.connecting)&&(this.open&&this.of("").packet({type:"disconnect"}),this.onDisconnect("booted")),this},d.prototype.disconnectSync=function(){var a=b.util.request(),c=["http"+(this.options.secure?"s":"")+":/",this.options.host+":"+this.options.port,this.options.resource,b.protocol,"",this.sessionid].join("/")+"/?disconnect=1";a.open("GET",c,!1),a.send(null),this.onDisconnect("booted")},d.prototype.isXDomain=function(){var a=c.location.port||("https:"==c.location.protocol?443:80);return this.options.host!==c.location.hostname||this.options.port!=a},d.prototype.onConnect=function(){this.connected||(this.connected=!0,this.connecting=!1,this.doBuffer||this.setBuffer(!1),this.emit("connect"))},d.prototype.onOpen=function(){this.open=!0},d.prototype.onClose=function(){this.open=!1,clearTimeout(this.heartbeatTimeoutTimer)},d.prototype.onPacket=function(a){this.of(a.endpoint).onPacket(a)},d.prototype.onError=function(a){a&&a.advice&&"reconnect"===a.advice&&(this.connected||this.connecting)&&(this.disconnect(),this.options.reconnect&&this.reconnect()),this.publish("error",a&&a.reason?a.reason:a)},d.prototype.onDisconnect=function(a){var b=this.connected,c=this.connecting;this.connected=!1,this.connecting=!1,this.open=!1,(b||c)&&(this.transport.close(),this.transport.clearTimeouts(),b&&(this.publish("disconnect",a),"booted"!=a&&this.options.reconnect&&!this.reconnecting&&this.reconnect()))},d.prototype.reconnect=function(){function a(){if(c.connected){for(var a in c.namespaces)c.namespaces.hasOwnProperty(a)&&""!==a&&c.namespaces[a].packet({type:"connect"});c.publish("reconnect",c.transport.name,c.reconnectionAttempts)}clearTimeout(c.reconnectionTimer),c.removeListener("connect_failed",b),c.removeListener("connect",b),c.reconnecting=!1,delete c.reconnectionAttempts,delete c.reconnectionDelay,delete c.reconnectionTimer,delete c.redoTransports,c.options["try multiple transports"]=e}function b(){return c.reconnecting?c.connected?a():c.connecting&&c.reconnecting?c.reconnectionTimer=setTimeout(b,1e3):(c.reconnectionAttempts++>=d?c.redoTransports?(c.publish("reconnect_failed"),a()):(c.on("connect_failed",b),c.options["try multiple transports"]=!0,c.transports=c.origTransports,c.transport=c.getTransport(),c.redoTransports=!0,c.connect()):(c.reconnectionDelay<f&&(c.reconnectionDelay*=2),c.connect(),c.publish("reconnecting",c.reconnectionDelay,c.reconnectionAttempts),c.reconnectionTimer=setTimeout(b,c.reconnectionDelay)),void 0):void 0}this.reconnecting=!0,this.reconnectionAttempts=0,this.reconnectionDelay=this.options["reconnection delay"];var c=this,d=this.options["max reconnection attempts"],e=this.options["try multiple transports"],f=this.options["reconnection limit"];this.options["try multiple transports"]=!1,this.reconnectionTimer=setTimeout(b,this.reconnectionDelay),this.on("connect",b)}}("undefined"!=typeof io?io:module.exports,"undefined"!=typeof io?io:module.parent.exports,this),function(a,b){function c(a,b){this.socket=a,this.name=b||"",this.flags={},this.json=new d(this,"json"),this.ackPackets=0,this.acks={}}function d(a,b){this.namespace=a,this.name=b}a.SocketNamespace=c,b.util.mixin(c,b.EventEmitter),c.prototype.$emit=b.EventEmitter.prototype.emit,c.prototype.of=function(){return this.socket.of.apply(this.socket,arguments)},c.prototype.packet=function(a){return a.endpoint=this.name,this.socket.packet(a),this.flags={},this},c.prototype.send=function(a,b){var c={type:this.flags.json?"json":"message",data:a};return"function"==typeof b&&(c.id=++this.ackPackets,c.ack=!0,this.acks[c.id]=b),this.packet(c)},c.prototype.emit=function(a){var b=Array.prototype.slice.call(arguments,1),c=b[b.length-1],d={type:"event",name:a};return"function"==typeof c&&(d.id=++this.ackPackets,d.ack="data",this.acks[d.id]=c,b=b.slice(0,b.length-1)),d.args=b,this.packet(d)},c.prototype.disconnect=function(){return""===this.name?this.socket.disconnect():(this.packet({type:"disconnect"}),this.$emit("disconnect")),this},c.prototype.onPacket=function(a){function c(){d.packet({type:"ack",args:b.util.toArray(arguments),ackId:a.id})}var d=this;switch(a.type){case"connect":this.$emit("connect");break;case"disconnect":""===this.name?this.socket.onDisconnect(a.reason||"booted"):this.$emit("disconnect",a.reason);
break;case"message":case"json":var e=["message",a.data];"data"==a.ack?e.push(c):a.ack&&this.packet({type:"ack",ackId:a.id}),this.$emit.apply(this,e);break;case"event":var e=[a.name].concat(a.args);"data"==a.ack&&e.push(c),this.$emit.apply(this,e);break;case"ack":this.acks[a.ackId]&&(this.acks[a.ackId].apply(this,a.args),delete this.acks[a.ackId]);break;case"error":a.advice?this.socket.onError(a):"unauthorized"==a.reason?this.$emit("connect_failed",a.reason):this.$emit("error",a.reason)}},d.prototype.send=function(){this.namespace.flags[this.name]=!0,this.namespace.send.apply(this.namespace,arguments)},d.prototype.emit=function(){this.namespace.flags[this.name]=!0,this.namespace.emit.apply(this.namespace,arguments)}}("undefined"!=typeof io?io:module.exports,"undefined"!=typeof io?io:module.parent.exports),function(a,b,c){function d(){b.Transport.apply(this,arguments)}a.websocket=d,b.util.inherit(d,b.Transport),d.prototype.name="websocket",d.prototype.open=function(){var a,d=b.util.query(this.socket.options.query),e=this;return a||(a=c.MozWebSocket||c.WebSocket),this.websocket=new a(this.prepareUrl()+d),this.websocket.onopen=function(){e.onOpen(),e.socket.setBuffer(!1)},this.websocket.onmessage=function(a){e.onData(a.data)},this.websocket.onclose=function(){e.onClose(),e.socket.setBuffer(!0)},this.websocket.onerror=function(a){e.onError(a)},this},d.prototype.send=b.util.ua.iDevice?function(a){var b=this;return setTimeout(function(){b.websocket.send(a)},0),this}:function(a){return this.websocket.send(a),this},d.prototype.payload=function(a){for(var b=0,c=a.length;c>b;b++)this.packet(a[b]);return this},d.prototype.close=function(){return this.websocket.close(),this},d.prototype.onError=function(a){this.socket.onError(a)},d.prototype.scheme=function(){return this.socket.options.secure?"wss":"ws"},d.check=function(){return"WebSocket"in c&&!("__addTask"in WebSocket)||"MozWebSocket"in c},d.xdomainCheck=function(){return!0},b.transports.push("websocket")}("undefined"!=typeof io?io.Transport:module.exports,"undefined"!=typeof io?io:module.parent.exports,this),function(a,b,c){function d(a){a&&(b.Transport.apply(this,arguments),this.sendBuffer=[])}function e(){}a.XHR=d,b.util.inherit(d,b.Transport),d.prototype.open=function(){return this.socket.setBuffer(!1),this.onOpen(),this.get(),this.setCloseTimeout(),this},d.prototype.payload=function(a){for(var c=[],d=0,e=a.length;e>d;d++)c.push(b.parser.encodePacket(a[d]));this.send(b.parser.encodePayload(c))},d.prototype.send=function(a){return this.post(a),this},d.prototype.post=function(a){function b(){4==this.readyState&&(this.onreadystatechange=e,f.posting=!1,200==this.status?f.socket.setBuffer(!1):f.onClose())}function d(){this.onload=e,f.socket.setBuffer(!1)}var f=this;this.socket.setBuffer(!0),this.sendXHR=this.request("POST"),c.XDomainRequest&&this.sendXHR instanceof XDomainRequest?this.sendXHR.onload=this.sendXHR.onerror=d:this.sendXHR.onreadystatechange=b,this.sendXHR.send(a)},d.prototype.close=function(){return this.onClose(),this},d.prototype.request=function(a){var c=b.util.request(this.socket.isXDomain()),d=b.util.query(this.socket.options.query,"t="+ +new Date);if(c.open(a||"GET",this.prepareUrl()+d,!0),"POST"==a)try{c.setRequestHeader?c.setRequestHeader("Content-type","text/plain;charset=UTF-8"):c.contentType="text/plain"}catch(e){}return c},d.prototype.scheme=function(){return this.socket.options.secure?"https":"http"},d.check=function(a,d){try{var e=b.util.request(d),f=c.XDomainRequest&&e instanceof XDomainRequest,g=a&&a.options&&a.options.secure?"https:":"http:",h=c.location&&g!=c.location.protocol;if(e&&(!f||!h))return!0}catch(i){}return!1},d.xdomainCheck=function(a){return d.check(a,!0)}}("undefined"!=typeof io?io.Transport:module.exports,"undefined"!=typeof io?io:module.parent.exports,this),function(a,b){function c(){b.Transport.XHR.apply(this,arguments)}a.htmlfile=c,b.util.inherit(c,b.Transport.XHR),c.prototype.name="htmlfile",c.prototype.get=function(){this.doc=new(window[["Active"].concat("Object").join("X")])("htmlfile"),this.doc.open(),this.doc.write("<html></html>"),this.doc.close(),this.doc.parentWindow.s=this;var a=this.doc.createElement("div");a.className="socketio",this.doc.body.appendChild(a),this.iframe=this.doc.createElement("iframe"),a.appendChild(this.iframe);var c=this,d=b.util.query(this.socket.options.query,"t="+ +new Date);this.iframe.src=this.prepareUrl()+d,b.util.on(window,"unload",function(){c.destroy()})},c.prototype._=function(a,b){this.onData(a);try{var c=b.getElementsByTagName("script")[0];c.parentNode.removeChild(c)}catch(d){}},c.prototype.destroy=function(){if(this.iframe){try{this.iframe.src="about:blank"}catch(a){}this.doc=null,this.iframe.parentNode.removeChild(this.iframe),this.iframe=null,CollectGarbage()}},c.prototype.close=function(){return this.destroy(),b.Transport.XHR.prototype.close.call(this)},c.check=function(a){if("undefined"!=typeof window&&["Active"].concat("Object").join("X")in window)try{var c=new(window[["Active"].concat("Object").join("X")])("htmlfile");return c&&b.Transport.XHR.check(a)}catch(d){}return!1},c.xdomainCheck=function(){return!1},b.transports.push("htmlfile")}("undefined"!=typeof io?io.Transport:module.exports,"undefined"!=typeof io?io:module.parent.exports),function(a,b,c){function d(){b.Transport.XHR.apply(this,arguments)}function e(){}a["xhr-polling"]=d,b.util.inherit(d,b.Transport.XHR),b.util.merge(d,b.Transport.XHR),d.prototype.name="xhr-polling",d.prototype.heartbeats=function(){return!1},d.prototype.open=function(){var a=this;return b.Transport.XHR.prototype.open.call(a),!1},d.prototype.get=function(){function a(){4==this.readyState&&(this.onreadystatechange=e,200==this.status?(f.onData(this.responseText),f.get()):f.onClose())}function b(){this.onload=e,this.onerror=e,f.retryCounter=1,f.onData(this.responseText),f.get()}function d(){f.retryCounter++,!f.retryCounter||f.retryCounter>3?f.onClose():f.get()}if(this.isOpen){var f=this;this.xhr=this.request(),c.XDomainRequest&&this.xhr instanceof XDomainRequest?(this.xhr.onload=b,this.xhr.onerror=d):this.xhr.onreadystatechange=a,this.xhr.send(null)}},d.prototype.onClose=function(){if(b.Transport.XHR.prototype.onClose.call(this),this.xhr){this.xhr.onreadystatechange=this.xhr.onload=this.xhr.onerror=e;try{this.xhr.abort()}catch(a){}this.xhr=null}},d.prototype.ready=function(a,c){var d=this;b.util.defer(function(){c.call(d)})},b.transports.push("xhr-polling")}("undefined"!=typeof io?io.Transport:module.exports,"undefined"!=typeof io?io:module.parent.exports,this),function(a,b,c){function d(){b.Transport["xhr-polling"].apply(this,arguments),this.index=b.j.length;var a=this;b.j.push(function(b){a._(b)})}var e=c.document&&"MozAppearance"in c.document.documentElement.style;a["jsonp-polling"]=d,b.util.inherit(d,b.Transport["xhr-polling"]),d.prototype.name="jsonp-polling",d.prototype.post=function(a){function c(){d(),e.socket.setBuffer(!1)}function d(){e.iframe&&e.form.removeChild(e.iframe);try{g=document.createElement('<iframe name="'+e.iframeId+'">')}catch(a){g=document.createElement("iframe"),g.name=e.iframeId}g.id=e.iframeId,e.form.appendChild(g),e.iframe=g}var e=this,f=b.util.query(this.socket.options.query,"t="+ +new Date+"&i="+this.index);if(!this.form){var g,h=document.createElement("form"),i=document.createElement("textarea"),j=this.iframeId="socketio_iframe_"+this.index;h.className="socketio",h.style.position="absolute",h.style.top="0px",h.style.left="0px",h.style.display="none",h.target=j,h.method="POST",h.setAttribute("accept-charset","utf-8"),i.name="d",h.appendChild(i),document.body.appendChild(h),this.form=h,this.area=i}this.form.action=this.prepareUrl()+f,d(),this.area.value=b.JSON.stringify(a);try{this.form.submit()}catch(k){}this.iframe.attachEvent?g.onreadystatechange=function(){"complete"==e.iframe.readyState&&c()}:this.iframe.onload=c,this.socket.setBuffer(!0)},d.prototype.get=function(){var a=this,c=document.createElement("script"),d=b.util.query(this.socket.options.query,"t="+ +new Date+"&i="+this.index);this.script&&(this.script.parentNode.removeChild(this.script),this.script=null),c.async=!0,c.src=this.prepareUrl()+d,c.onerror=function(){a.onClose()};var f=document.getElementsByTagName("script")[0];f.parentNode.insertBefore(c,f),this.script=c,e&&setTimeout(function(){var a=document.createElement("iframe");document.body.appendChild(a),document.body.removeChild(a)},100)},d.prototype._=function(a){return this.onData(a),this.isOpen&&this.get(),this},d.prototype.ready=function(a,c){var d=this;return e?(b.util.load(function(){c.call(d)}),void 0):c.call(this)},d.check=function(){return"document"in c},d.xdomainCheck=function(){return!0},b.transports.push("jsonp-polling")}("undefined"!=typeof io?io.Transport:module.exports,"undefined"!=typeof io?io:module.parent.exports,this),"function"==typeof define&&define.amd&&define([],function(){return io})}(),notifications={create:function(a){$("#statusbar").html(a+' <span class="close-notification">Dismiss</span>').css("display","inline"),clearTimeout(notifications.timeout),notifications.timeout=setTimeout(function(){$("#statusbar").fadeOut()},5e3)},timeout:setTimeout(function(){},999999999)},sockets={connected:!1};var socket=io.connect(window.location.origin),pladdfail=function(a){$(".new-playlist-input").hide();var b=$("<div>",{"class":"playlist-addition-failed"}).text(a);b.prependTo(".playlists-menu").delay(3e3).slideUp()},pladded=function(a){$(".new-playlist-input").hide(),$(".playlists-menu").prepend(a.div),chinchilla.playlists.push(a.playlist)};socket.on("connected",function(){sockets.connected=!0}),socket.on("track-added",function(a){notifications.create(a.notification);var b=$('[data-route="/library"]  .extendedtable tbody');"top"==a.position?b.find(".song").eq(0).before(a.song):b.append(a.song),$('.song[data-id="'+$(a.song).attr("data-id")+'"]').addClass("in-library animated").removeClass("not-in-library")}),socket.on("tracks-added",function(a){var b=$('[data-route="/library"]  .extendedtable tbody');$.each(a.divs,function(c,d){"top"==a.position?b.find(".song").eq(0).before(d):b.append(d),$('.song[data-id="'+$(d).attr("data-id")+'"]').addClass("in-library animated").removeClass("not-in-library")}),_.each(a.tracks,function(a){chinchilla.library.push(a)}),notifications.create(a.notification)}),socket.on("tracks-removed",function(a){var b=$('[data-route="/library"]  .extendedtable tbody');$.each(a.tracks,function(a,c){var c=b.find('[data-id="'+c+'"]').remove()}),notifications.create(a.notification),_.each(a.tracks,function(a){chinchilla.library=_.without(chinchilla.library,a)})}),socket.on("track-removed",function(a){notifications.create(a.notification);var b=$('[data-route="/library"]');b.find('[data-id="'+a.id+'"]').remove(),chinchilla.library=_.without(chinchilla.library,a.id)}),socket.on("playlist-added",pladded),socket.on("playlist-renamed",pladded),socket.on("playlist-addition-failed",pladdfail),socket.on("playlist-renamed-failed",pladdfail),socket.on("playlist-removed",function(a){$("#sidebar [data-navigate='"+a.url+"']").remove()}),socket.on("notification",function(a){notifications.create(a.html)}),socket.on("tracks-added-to-collection",function(a){notifications.create(a.html)}),socket.on("playlist-song-removed",function(a){listChanged(a),$("[data-url='"+a.view+"']").addClass("add-song-to-playlist-button not-in-playlist").removeClass("remove-song-from-playlist-button in-playlist contains-song").find(".song-page-playlist-trackcount").text(a.trackcount);var b=$('[data-route="'+a.view+'"]');b.find('[data-id="'+a.songid+'"]').remove(),libdom.removeSongsFromPlaylistLocal(a.view,[a.songid])}),socket.on("playlist-song-added",function(a){var b=listChanged(a);$("[data-url='"+a.view+"']").removeClass("add-song-to-playlist-button not-in-playlist").addClass("remove-song-from-playlist-button in-playlist contains-song").find(".song-page-playlist-trackcount").text(a.trackcount),"top"==a.position&&0!=b.find(".song").length?b.find(".song").eq(0).before(a.song):b.append(a.song)}),socket.on("multiple-playlist-songs-added",function(a){var b=listChanged(a);$.each(a.divs,function(c,d){"top"==a.position&&0!=b.find(".song").length?b.find(".song").eq(0).before(d):b.append(d)}),libdom.addSongsToPlaylistLocal(a.view,a.tracks),_.each(a.songs,function(a){DB.addTrack(a)}),_.each(a.tracks,function(b){$('[data-route="/song/'+b+'"]').find("[data-url='"+a.view+"']").removeClass("add-song-to-playlist-button not-in-playlist").addClass("remove-song-from-playlist-button in-playlist contains-song").find(".song-page-playlist-trackcount").text(a.trackcount)}),notifications.create(a.notification)}),socket.on("multiple-playlist-songs-removed",function(a){var b=listChanged(a);libdom.removeSongsFromPlaylistLocal(a.view,a.tracks),_.each(a.tracks,function(a){b.find('[data-id="'+a+'"]').remove()}),notifications.create(a.notification)}),socket.on("/pairing/other-device-disconnected",function(){console.log("Mobile disconnected"),chinchilla.paired=!1}),socket.on("/pairing/receive-action",function(a){switch(a.action){case"play":player.play();break;case"pause":player.pause();break;case"previous":player.playLast();break;case"next":player.playNext()}}),socket.on("/pairing/registered",function(a){chinchilla.paired=a.code}),_.templateSettings.variable="tmpl",templates={},templates.buildLibrary=function(a){var b=_.template($("#template-library").html());return a.coverstack=helpers.coverArrayToHQ(_.first(_.pluck(a.tracks,"image"),4),225),a.showartistalbum=!0,a.rawduration=_.reduce(a.tracks,function(a,b){return a+parseFloat(b.duration)},0),a.duration=helpers.parsehours(a.rawduration),a.trackcount=a.tracks.length,a.tracks=_.map(a.tracks,function(a){return a.inlib=!0,a}),a.tracklist=templates.buildTrackList(a),b(a)},templates.buildPlaylist=function(a){var b=_.template($("#template-playlist").html());return a.coverstack=helpers.coverArrayToHQ(_.first(_.pluck(a.tracks,"image"),4),225),a.showartistalbum=!0,a.tracklist=templates.buildTrackList(a),a.playlist.rawduration=_.reduce(a.tracks,function(a,b){return a+parseFloat(b.duration)},0),a.playlist.duration=helpers.parsehours(a.playlist.rawduration),a.playlist.trackcount=a.tracks.length,b(a)},templates.buildTrackList=function(a){a.album={cds:[[a.tracks]]};var b=_.template($("#template-tracklist").html());return b(a)},templates.buildSongsInList=function(a,b){data={cd:a};var c=_.template($("#template-song").html());return $.each(b,function(a,b){data[a]=b}),c(data)},templates.buildSongContextMenu=function(a){var b=_.template($("#template-contextmenu").html());return b(a)},templates.buildFilter=function(a){var b=function(b){var c=_.groupBy(b,function(a){return a.genre}),d=$("#template-filter").html(),e=$(".filter-dropdown");e.html(_.template(d,{genres:c})),_.each($(".filter-genre"),function(b){$(b).on("change",function(){var b=_.map($(".filter-genre:checked"),function(a){return a.dataset.genre}),c=$('[data-represents="'+a.list+'"] .song');0==b.length?$(c).show():_.each(c,function(a){_.contains(b,a.dataset.genre)?$(a).show():$(a).hide()})})})};"/library"==a.list?DB.getTracks({ids:chinchilla.library,callback:b}):DB.getTracks({ids:_.where(chinchilla.playlists,{url:a.list})[0].tracks,callback:b})},player={},player.playSong=function(a,b,c){var d=helpers.parseDOM(a);if($(a).hasClass("recognized")||void 0!=d.ytid)d=videoIdReplacements(d),b?ytplayer.cueVideoById(d.ytid):(ytplayer.loadVideoById?ytplayer.loadVideoById(d.ytid):setTimeout(function(){player.playSong(a,b,c)},250),$("#seek-bar").addClass("buffering")),c||player.history.add(player.nowPlaying.get()),player.nowPlaying.replace(d,b),$("title").text(d.name+" - "+d.artist),chinchilla.settings.favicon_album&&$("#favicon").attr("href",d.image);else{var e=a instanceof HTMLElement?$(a):$(".song[data-id="+a.id+"]")[0];$(e).addClass("wantstobeplayed"),recognition.stop(),recognition.queue.unshift(d),recognition.start()}},updateHints=function(){var a=player.queue1.get(),b=player.queue2.get(),c=a.concat(b),d=c.shift(),e=player.history.get(),f=e.pop(),g=void 0!=d?"<strong>"+d.name+"</strong><br>"+d.artist:"There is no track in your queue!",h=void 0!=f?"<strong>"+f.name+"</strong><br>"+f.artist:"There is no track in your history!";$(".next-update").html(g),$(".prev-update").html(h),$("#skip").attr("data-tooltip","<div class='next-update'>"+g+"</div>"),$("#rewind").attr("data-tooltip","<div class='prev-update'>"+h+"</div>")},player.nowPlaying={replace:function(a){var b=player.nowPlaying.get(),a=helpers.parseDOM(a);localStorage.nowPlaying=JSON.stringify(a),console.log(a),$("#track-title a").text(a.name).attr("data-navigate","/song/"+a.id),$("#track-artist a").text(a.artist).attr("data-navigate","/artist/"+a.artistid),$("#track-album a").text(a.album).attr("data-navigate","/album/"+a.albumid);var c=$("#nowplaying-image"),d=$("#nowplaying-image2"),e=helpers.getHQAlbumImage(a,225);$("#sidebar-player").is(":visible")||player.show(),(b&&b.image!=a.image||""==c.attr("src")&&""==c.attr("src"))&&(c.hasClass("np-placeholder-used")?(c.removeClass("np-placeholder-used").attr("src",""),d.attr("src",e).addClass("np-placeholder-used").one("load",function(){$(d).css({opacity:1},400),$(c).css({opacity:0},400)})):(d.removeClass("np-placeholder-used").attr("src",""),c.attr("src",e).addClass("np-placeholder-used").one("load",function(){$(c).css({opacity:1},400),$(d).css({opacity:0},400)}))),$(".song").removeClass("now-playing hearable"),$(".song[data-id='"+a.id+"']").addClass("now-playing"),updateHints(),remote.updateTrack()},get:function(){return helpers.localStorageSafety("nowPlaying"),"[]"==localStorage.nowPlaying?null:JSON.parse(localStorage.nowPlaying)}};var Queue=function(a){this.add=function(b,c){var b=helpers.parseDOM(b),d=a;return helpers.localStorageSafety(d),helpers.addToLocalStorage(d,b,c),player.drawQueue(),updateHints(),helpers.getLocalStorage(d)},this.get=function(){return helpers.getLocalStorage(a)},this.clear=function(){return helpers.clearLocalStorage(a)},this.getAndRemoveFirst=function(){var b=helpers.getLocalStorage(a),c=b.splice(0,1);return localStorage[a]=JSON.stringify(b),player.drawQueue(),c[0]},"history"==a&&(this.playLast=function(){var b=helpers.getLocalStorage(a);if(0!=b.length){player.queue1.add(player.nowPlaying.get(),!0);var c=b.pop();localStorage[a]=JSON.stringify(b),player.playSong(c,!1,!0),player.drawQueue()}})};player.queue1=new Queue("queue1"),player.queue2=new Queue("queue2"),player.history=new Queue("history"),player.automaticseekblocked=!1;var stateChange=function(a){1==a?($("#play").hide(),$("#pause").show(),$("#seek-bar").removeClass("buffering"),$(".now-playing").addClass("hearable")):(0==a&&player.playNext(),2==a&&$(".now-playing").removeClass("hearable"),$("#pause").hide(),$("#play").show())},videoEnded=function(){player.playNext()},videoIdReplacements=function(a){helpers.localStorageSafetyObject("videoIdReplacements");var b=helpers.getLocalStorage("videoIdReplacements"),c=b[a.ytid];return void 0!=c&&(a.ytid=c),a},replaceVideo=function(a,b){helpers.localStorageSafety("videoIdReplacements");var c=JSON.parse(localStorage.videoIdReplacements);c[a]=b,localStorage.videoIdReplacements=JSON.stringify(c)},errorOccured=function(a){0==a?notifications.create("The video could not be loaded due to some country restrictions. Looking for an alternative..."):notifications.create("A unknown error happened while trying to play the video. Looking for an altenative..."),helpers.localStorageSafety("banned_videos");var b=JSON.parse(localStorage.banned_videos);b.push(player.nowPlaying.get().ytid),localStorage.banned_videos=JSON.stringify(b);var c=player.nowPlaying.get();recognition.findVideo(c,function(a){if(void 0!=a){var b=c.ytid,d=a.media$group.yt$videoid.$t;c.ytid=d,replaceVideo(b,d),player.playSong(c,!1,!0),notifications.create("Alternative found. In the future, this video will be played.")}else notifications.create("No video available in your country was found. We cannot play this song, sorry.")},void 0,void 0,void 0,["restricted"])};player.show=function(){$("#sidebar-player").slideDown(600).animate({opacity:1}),$('[data-navigate="/youtube"]').show()},player.setUpEvents=function(){ytplayer.addEventListener("onStateChange","stateChange"),ytplayer.addEventListener("onEnded","videoEnded"),ytplayer.addEventListener("onError","errorOccured");var a=function(){var b=ytplayer.getCurrentTime(),c=ytplayer.getDuration(),d=helpers.parsetime(b),e=helpers.parsetime(c);document.getElementById("time-right").innerHTML=e,document.getElementById("time-left").innerHTML=d;var f,g=100*(b/c);if(!player.automaticseekblocked&&g)var f=g;if(0/0==g)var f=0;document.getElementById("seek-progress").style.width=f+"%",setTimeout(a,500)};a()},player.pause=function(){ytplayer.pauseVideo()},player.play=function(){ytplayer.playVideo()},player.seek=function(a){ytplayer.seekTo(a)},player.playNext=function(){var a=0==player.queue1.get().length?"queue2":"queue1",b=player[a].getAndRemoveFirst();player.playSong(b)},player.playLast=function(){player.history.playLast()},player.drawQueue=function(){var a=player.queue1.get(),b=player.queue2.get();queue=a.concat(b),queue=queue.slice(0,10),$("#queue").empty(),$.each(queue,function(a,b){var c={"data-tooltip":"<strong>"+b.name+"</strong><br>"+b.artist,"class":"queue-song"};$.each(b,function(a,b){c["data-"+a]=b});var d=$("<div>",c);$("<img>",{src:b.image}).appendTo(d),d.appendTo("#queue")})},player.togglePlayState=function(){var a=ytplayer.getPlayerState();1==a?player.pause():player.play()},search={calls:[],autocomplete:function(a){var b=$("#search-results-wrapper");search.calls=[];var c={artist:{iTunesName:"musicArtist",title:"artistName",sub:"primaryGenreName",element:$("#results-artists"),link:"/artist/$1",id:"artistId",image:"svg-artist-black"},album:{iTunesName:"album",title:"collectionName",sub:"artistName",element:$("#results-albums"),link:"/album/$1",id:"collectionId",image:"svg-album-black"},track:{iTunesName:"song",title:"trackName",sub:"artistName",element:$("#results-tracks"),link:"/song/$1",id:"trackId",image:"svg-music-black"}},d={count:0,objects:[]},e=function(c){var c=_.sortBy(c.objects,function(b,c){var d=_s.levenshtein(b.title,a),e=_s.levenshtein(b.sub,a)+.5+(c+1)%3;return Math.min(d,e)}),c=_.map(c,function(b){return new RegExp(a,"gi"),b});b.empty(),_.each(c,function(a,c){var d=$('<li data-navigate="'+a.link+'"><a><img src="/api/i/pixel" class="'+a.image+'"><span>'+a.title+'</span><span class="search-result-sub">'+a.sub+"</span></a></li>");if(0==c)var d=$(d).addClass("search-selected");g(),b.append(d)})},f=function(){$("#search-spinner").show()},g=function(){$("#search-spinner").hide()};f(),$.each(c,function(b,c){var f=$.ajax({url:"http://itunes.apple.com/search",data:{term:a,entity:c.iTunesName,limit:3},dataType:"jsonp",success:function(a){_.each(a.results,function(a){d.objects.push({title:a[c.title],sub:a[c.sub],type:b,link:c.link.replace("$1",a[c.id]),image:c.image})}),d.count++,3==d.count&&e(d)}});search.calls.push(f)})}},addtracks={calls:[],autocomplete:function(a){search.calls=[];var b={track:{iTunesName:"song",title:"trackName",sub:"artistName",element:$(".add-tracks-results"),id:"trackId"}};$.each(b,function(b,c){var d=$.ajax({url:"http://itunes.apple.com/search",data:{term:a,entity:c.iTunesName,limit:3},dataType:"jsonp",success:function(a){$(c.element).empty(),$.each(a.results,function(a,b){var d=$("<div>",{"class":"search-result"});$("<div>",{"class":"search-result-title"}).text(b[c.title]).appendTo(d),$("<div>",{"class":"search-result-sub"}).text(b[c.sub]).appendTo(d);var e=$("<span>",{"data-id":b.trackId}).html(d).on("click",function(){var a=$("#view").attr("data-route");"/library"==a?library.add({id:b.trackId}):playlist.add({id:b.trackId},a),$(".add-tracks-input").val("").focus(),c.element.html(""),window.lastsearchtimestamp=null});e.appendTo(c.element),0==a&&$(e).addClass("add-tracks-selected")})}});search.calls.push(d)})}};var addToCollections,addToImportQueue,cancelEverything,determineProvider,determineTarget,droparea,fileDropped,importqueue,queuechanged,queuestarted,recognize,recognizeFile,recognizeSpotify,recognizeTracks,startQueue,stopQueue,textDropped,weirdThingDropped;droparea=$("#view"),importqueue=[],queuestarted=!1,cancelEverything=function(a){return a.stopPropagation(),a.preventDefault()},fileDropped=function(a){return _.each(a,function(a){var b;return b={type:{provider:"file",id:a},target:determineTarget()},addToImportQueue(b)})},textDropped=function(a){var b;return b=a.split(/\n/),_.each(b,function(a){var b;return b={type:determineProvider(a),target:determineTarget()},b.type?addToImportQueue(b):void 0})},weirdThingDropped=function(){return console.log("something was dropped")},determineTarget=function(){return document.getElementById("view").dataset.route},determineProvider=function(a){return 52===a.length&&"http://open.spotify.com/track/"===a.substr(0,30)?{provider:"spotify",id:a.substr(30)}:"http://www.youtube.com/watch"===a.substr(0,28)?{provider:"youtube",id:a.substr(31,11)}:!1},addToImportQueue=function(a){importqueue.push(a),$(".import-trackcount").text(importqueue.length+(1==importqueue.length?" track":" tracks")),$("#importqueue").append(_.template($("#import-track-template").html(),{track:a})),0!=importqueue.length&&$(".import-no-tracks").remove()},queuechanged=function(){if(queuestarted){if(0===importqueue.length)return stopQueue()}else if(0!==importqueue.length)return startQueue()},startQueue=function(){return queuestarted=!0,console.log("Queue started"),$("body").addClass("queuestarted"),recognizeTracks()},stopQueue=function(){return queuestarted=!1,$("body").removeClass("queuestarted"),console.log("Queue ended")},recognizeTracks=function(){var a;return 0==importqueue.length?(stopQueue(),void 0):(a=importqueue.shift(),recognize(a,function(b){return addToCollections(a,b),queuechanged(),0!==importqueue.length?recognizeTracks():void 0}))},recognize=function(a,b){return"spotify"===a.type.provider?recognizeSpotify(a,function(a){return b(a)}):"file"===a.type.provider?recognizeFile(a,function(a){return b(a)}):void 0},recognizeSpotify=function(a,b){var c=$('.import-track[data-importid="'+a.type.provider+"-"+a.type.id+'"]'),d=$(c).find(".import-status"),e=$(c).find(".import-trackname");return d.text("Looking up track..."),$.getJSON("http://ws.spotify.com/lookup/1/.json?uri=spotify:track:"+a.type.id,function(c){return a={name:c.track.name,artist:c.track.artists[0].name},e.text(a.name+" - "+a.artist),d.text("Requesting track info..."),socket.emit("request-track-info",a),socket.once("receive-track-info",function(a){var c;return a.error?(d.text("Not found on Tunechilla."),b(null)):(c=a.song,d.text("Finding YouTube video..."),recognition.findVideo(c,function(a){return a?(c.ytid=helpers.parseYTId(a),socket.emit("new-track",c),d.text("Adding..."),socket.once("track-uploaded",function(a){return a===c.id?(d.text("Imported."),b(c)):void 0})):(d.text("No video found."),b(null))}))})})},recognizeFile=function(a,b){var c;return c=new FileReader,c.onload=function(){var c;return c=new jDataView(this.result),"TAG"===c.getString(3,c.byteLength-128)?(a={name:c.getString(30,c.tell()),artist:c.getString(30,c.tell())},console.log(a),socket.emit("request-track-info",a),socket.once("receive-track-info",function(a){var c;return a.error?(console.log("no track found"),b(null)):(c=a.song,recognition.findVideo(c,function(a){return c.ytid=helpers.parseYTId(a),socket.emit("new-track",c),socket.once("track-uploaded",function(a){return a===c.id?b(c):void 0})}))})):(console.log("NO ID3"),b(null))},c.readAsArrayBuffer(a.type.id)},addToCollections=function(a,b){var c;return c=chinchilla.playlist_target?chinchilla.playlist_target:"/library",b?_s.contains(c,"/u/")&&_s.contains(c,"/p/")?socket.emit("add-tracks-to-collection",{token:chinchilla.token,tracks:[b.id],destination:c,type:"playlist"}):socket.emit("add-tracks-to-collection",{token:chinchilla.token,tracks:[b.id],destination:"library",type:"library"}):void 0},$(document).ready(function(){return document.addEventListener("dragenter",function(a){return cancelEverything(a)}),document.getElementById("dropfiles").addEventListener("dragleave",function(){return document.getElementById("dropfiles").className="",document.getElementById("dropfilescontent").className=""}),document.addEventListener("dragover",function(a){return document.getElementById("dropfiles").className="drag-hover",document.getElementById("dropfilescontent").className="drag-hover",cancelEverything(a)}),document.addEventListener("drop",function(a){var b,c;document.getElementById("dropfiles").className="",document.getElementById("dropfilescontent").className="",cancelEverything(a),b=a.dataTransfer.files,c=a.dataTransfer.getData("Text");var d=window.location.pathname;return"/import"!=window.location.pathname&&((_s.contains(d,"/u/")&&_s.contains(d,"/p/")||"/library"==d)&&(chinchilla.playlist_target=d),navigation.to("/import")),0!==b.length?fileDropped(b):""!==c?textDropped(c):weirdThingDropped()})}),errors={draw:function(a){$("#view").load("/api/error/"+a)}};var recognitionAdditionHandler=function(){0==recognition.started&&recognition.start()};recognition={recognizeAlbum:function(a){var b=$(a).find(".album-tracks table tbody tr.song.not-recognized");$.each(b,function(a,b){recognition.queue.push(b)})},recognizeTrackList:function(a){var b=$(a).find("tr.song.not-recognized");$.each(b,function(a,b){recognition.queue.push(b)})},queue:new EventedArray(recognitionAdditionHandler),recognizeTrack:function(a){var b=a.track,c=a.cb,d=helpers.parseDOM(b),e=void 0!=b.length&&0!=b.length?b[0]:b,f=e instanceof HTMLElement?$(e):$(".song[data-id="+e.id+"]")[0];return $(f).hasClass("recognized")?(c(),void 0):(recognition.findVideo(d,function(a){if(a){var e=$('.song[data-id="'+d.id+'"]').attr("data-ytid",a.id.$t.substr(-11));e.addClass("recognized").removeClass("not-recognized pending"),recognition.uploadTrack(d,a),$(e).hasClass("wantstobeplayed")&&($(e).removeClass("wantstobeplayed"),player.playSong($(e)[0]));var g=$(b).parents(".album");if(0!=g.length){var h=$(b).parents(".album").find(".recognized").length+1,i=g.data("tracks");h==i&&recognition.uploadAlbum(g[0])}}else $(f).addClass("no-video-found");c()}),void 0)},started:!1,start:function(){recognition.started=!0;var a=function(){recognition.recognizeTrack({track:recognition.queue.getArray()[0],cb:function(){recognition.started&&(recognition.queue.shift(),0==recognition.queue.getArray().length?recognition.stop():a())}})};a()},stop:function(){recognition.started=!1},findVideo:function(a,b,c,d,e,f){void 0!=c&&($=c),void 0!=d&&(_=d),void 0!=e&&(_s=e),a.name=void 0==a.title?a.name:a.title;var g={alt:"json","max-results":15,q:a.artist+" "+a.name,v:2};void 0!=f&&_.contains(f,"restricted")&&(g.restricted="DE"),$.ajax({url:"http://gdata.youtube.com/feeds/api/videos",data:g,success:function(c){console.log(c),recognition.findBestVideo(c,a,function(a){console.log(a),b(a)},_,_s,f)}})},findBestVideo:function(a,b,c,d,e){var f=a.feed.entry,g=d.max(f,function(a){var b=void 0!=a.yt$statistics?parseFloat(a.yt$statistics.viewCount):0;return b});if(!g)return c(null),void 0;if(mostviews=g.yt$statistics?g.yt$statistics.viewCount:0,"undefined"!=typeof localStorage){helpers.localStorageSafety("banned_videos");var h=JSON.parse(localStorage.banned_videos),f=d.reject(f,function(a){return d.contains(h,a.media$group.yt$videoid.$t)})}d.map(f,function(a){a.points=0;var c=e.slugify(a.title.$t),f=e.slugify(b.artist+" "+b.name);e.slugify(b.name+" "+b.artist);var g=helpers.titleMatcher(a.title.$t,d),h=g.join(" "),i=helpers.titleMatcher(b.artist+" "+b.name,d),j=[],k=[];d.each(i,function(a){var b=h.indexOf(a);-1==b?k.push(a):(j.push(a),h=h.replace(a,""))});var l=300*(j.length/i.length)-2*h.replace(/\s/g,"").length;l=0>l?0:l,console.log("Levenshtein",l),a.points+=l;var m=a.media$group.yt$duration.seconds,n=b.duration/1e3,o=Math.abs(m-n);tolerance=1,minuspoints=0===o?0:o-1,durpoints=minuspoints,a.points-=durpoints,console.log("video duration points",durpoints);var p=a.yt$statistics?parseFloat(a.yt$statistics.viewCount):0,q=p/mostviews;
viepoints=Math.ceil(50*q),console.log("viepoints",viepoints),a.points+=viepoints;var r=a.gd$rating?20*a.gd$rating.average:0;ratpoints=Math.ceil(1.5*r),a.points+=ratpoints,a.points+=200;var s=["cover","parod","chipmunk","snippet","preview","live","review","vocaloid","dance","remix"];d.each(s,function(b){e.include(c.toLowerCase(),b)&&!e.include(f,b)&&(a.points-=75)}),a.points+=50,e.include(c.toLowerCase()),b.album&&(e.include(f,"skit")||e.include(f,"intro")||e.include(f,"outro"))&&(a.points-=50)});var i=d.first(d.sortBy(f,function(a){return a.points}).reverse());i&&console.log("The best video has ",i.points," points!",b.name),c(i)},uploadTrack:function(a,b){var c=b.id.$t.substr(-11),d=a;d.ytid=c,d.id=parseFloat(d.id),socket.emit("new-ytid",d),DB.addYTIDToTrack(a,c)},uploadAlbum:function(a){var b=$(a).data(),c=$(a).find(".song"),d=[];$.each(c,function(a,b){d.push($(b).data("id"))}),b.tracklist=d,socket.emit("new-album",b)}},this.recognition=recognition;var swfobject=function(){function a(){if(!R){try{var a=K.getElementsByTagName("body")[0].appendChild(q("span"));a.parentNode.removeChild(a)}catch(b){return}R=!0;for(var c=N.length,d=0;c>d;d++)N[d]()}}function b(a){R?a():N[N.length]=a}function c(a){if(typeof J.addEventListener!=C)J.addEventListener("load",a,!1);else if(typeof K.addEventListener!=C)K.addEventListener("load",a,!1);else if(typeof J.attachEvent!=C)r(J,"onload",a);else if("function"==typeof J.onload){var b=J.onload;J.onload=function(){b(),a()}}else J.onload=a}function d(){M?e():f()}function e(){var a=K.getElementsByTagName("body")[0],b=q(D);b.setAttribute("type",G);var c=a.appendChild(b);if(c){var d=0;!function(){if(typeof c.GetVariable!=C){var e=c.GetVariable("$version");e&&(e=e.split(" ")[1].split(","),U.pv=[parseInt(e[0],10),parseInt(e[1],10),parseInt(e[2],10)])}else if(10>d)return d++,setTimeout(arguments.callee,10),void 0;a.removeChild(b),c=null,f()}()}else f()}function f(){var a=O.length;if(a>0)for(var b=0;a>b;b++){var c=O[b].id,d=O[b].callbackFn,e={success:!1,id:c};if(U.pv[0]>0){var f=p(c);if(f)if(!s(O[b].swfVersion)||U.wk&&U.wk<312)if(O[b].expressInstall&&h()){var k={};k.data=O[b].expressInstall,k.width=f.getAttribute("width")||"0",k.height=f.getAttribute("height")||"0",f.getAttribute("class")&&(k.styleclass=f.getAttribute("class")),f.getAttribute("align")&&(k.align=f.getAttribute("align"));for(var l={},m=f.getElementsByTagName("param"),n=m.length,o=0;n>o;o++)"movie"!=m[o].getAttribute("name").toLowerCase()&&(l[m[o].getAttribute("name")]=m[o].getAttribute("value"));i(k,l,c,d)}else j(f),d&&d(e);else u(c,!0),d&&(e.success=!0,e.ref=g(c),d(e))}else if(u(c,!0),d){var q=g(c);q&&typeof q.SetVariable!=C&&(e.success=!0,e.ref=q),d(e)}}}function g(a){var b=null,c=p(a);if(c&&"OBJECT"==c.nodeName)if(typeof c.SetVariable!=C)b=c;else{var d=c.getElementsByTagName(D)[0];d&&(b=d)}return b}function h(){return!S&&s("6.0.65")&&(U.win||U.mac)&&!(U.wk&&U.wk<312)}function i(a,b,c,d){S=!0,y=d||null,z={success:!1,id:c};var e=p(c);if(e){"OBJECT"==e.nodeName?(w=k(e),x=null):(w=e,x=c),a.id=H,(typeof a.width==C||!/%$/.test(a.width)&&parseInt(a.width,10)<310)&&(a.width="310"),(typeof a.height==C||!/%$/.test(a.height)&&parseInt(a.height,10)<137)&&(a.height="137"),K.title=K.title.slice(0,47)+" - Flash Player Installation";var f=U.ie&&U.win?"ActiveX":"PlugIn",g="MMredirectURL="+J.location.toString().replace(/&/g,"%26")+"&MMplayerType="+f+"&MMdoctitle="+K.title;if(typeof b.flashvars!=C?b.flashvars+="&"+g:b.flashvars=g,U.ie&&U.win&&4!=e.readyState){var h=q("div");c+="SWFObjectNew",h.setAttribute("id",c),e.parentNode.insertBefore(h,e),e.style.display="none",function(){4==e.readyState?e.parentNode.removeChild(e):setTimeout(arguments.callee,10)}()}l(a,b,c)}}function j(a){if(U.ie&&U.win&&4!=a.readyState){var b=q("div");a.parentNode.insertBefore(b,a),b.parentNode.replaceChild(k(a),b),a.style.display="none",function(){4==a.readyState?a.parentNode.removeChild(a):setTimeout(arguments.callee,10)}()}else a.parentNode.replaceChild(k(a),a)}function k(a){var b=q("div");if(U.win&&U.ie)b.innerHTML=a.innerHTML;else{var c=a.getElementsByTagName(D)[0];if(c){var d=c.childNodes;if(d)for(var e=d.length,f=0;e>f;f++)1==d[f].nodeType&&"PARAM"==d[f].nodeName||8==d[f].nodeType||b.appendChild(d[f].cloneNode(!0))}}return b}function l(a,b,c){var d,e=p(c);if(U.wk&&U.wk<312)return d;if(e)if(typeof a.id==C&&(a.id=c),U.ie&&U.win){var f="";for(var g in a)a[g]!=Object.prototype[g]&&("data"==g.toLowerCase()?b.movie=a[g]:"styleclass"==g.toLowerCase()?f+=' class="'+a[g]+'"':"classid"!=g.toLowerCase()&&(f+=" "+g+'="'+a[g]+'"'));var h="";for(var i in b)b[i]!=Object.prototype[i]&&(h+='<param name="'+i+'" value="'+b[i]+'" />');e.outerHTML='<object classid="clsid:D27CDB6E-AE6D-11cf-96B8-444553540000"'+f+">"+h+"</object>",P[P.length]=a.id,d=p(a.id)}else{var j=q(D);j.setAttribute("type",G);for(var k in a)a[k]!=Object.prototype[k]&&("styleclass"==k.toLowerCase()?j.setAttribute("class",a[k]):"classid"!=k.toLowerCase()&&j.setAttribute(k,a[k]));for(var l in b)b[l]!=Object.prototype[l]&&"movie"!=l.toLowerCase()&&m(j,l,b[l]);e.parentNode.replaceChild(j,e),d=j}return d}function m(a,b,c){var d=q("param");d.setAttribute("name",b),d.setAttribute("value",c),a.appendChild(d)}function n(a){var b=p(a);b&&"OBJECT"==b.nodeName&&(U.ie&&U.win?(b.style.display="none",function(){4==b.readyState?o(a):setTimeout(arguments.callee,10)}()):b.parentNode.removeChild(b))}function o(a){var b=p(a);if(b){for(var c in b)"function"==typeof b[c]&&(b[c]=null);b.parentNode.removeChild(b)}}function p(a){var b=null;try{b=K.getElementById(a)}catch(c){}return b}function q(a){return K.createElement(a)}function r(a,b,c){a.attachEvent(b,c),Q[Q.length]=[a,b,c]}function s(a){var b=U.pv,c=a.split(".");return c[0]=parseInt(c[0],10),c[1]=parseInt(c[1],10)||0,c[2]=parseInt(c[2],10)||0,b[0]>c[0]||b[0]==c[0]&&b[1]>c[1]||b[0]==c[0]&&b[1]==c[1]&&b[2]>=c[2]?!0:!1}function t(a,b,c,d){if(!U.ie||!U.mac){var e=K.getElementsByTagName("head")[0];if(e){var f=c&&"string"==typeof c?c:"screen";if(d&&(A=null,B=null),!A||B!=f){var g=q("style");g.setAttribute("type","text/css"),g.setAttribute("media",f),A=e.appendChild(g),U.ie&&U.win&&typeof K.styleSheets!=C&&K.styleSheets.length>0&&(A=K.styleSheets[K.styleSheets.length-1]),B=f}U.ie&&U.win?A&&typeof A.addRule==D&&A.addRule(a,b):A&&typeof K.createTextNode!=C&&A.appendChild(K.createTextNode(a+" {"+b+"}"))}}}function u(a,b){if(T){var c=b?"visible":"hidden";R&&p(a)?p(a).style.visibility=c:t("#"+a,"visibility:"+c)}}function v(a){var b=/[\\\"<>\.;]/,c=null!=b.exec(a);return c&&typeof encodeURIComponent!=C?encodeURIComponent(a):a}var w,x,y,z,A,B,C="undefined",D="object",E="Shockwave Flash",F="ShockwaveFlash.ShockwaveFlash",G="application/x-shockwave-flash",H="SWFObjectExprInst",I="onreadystatechange",J=window,K=document,L=navigator,M=!1,N=[d],O=[],P=[],Q=[],R=!1,S=!1,T=!0,U=function(){var a=typeof K.getElementById!=C&&typeof K.getElementsByTagName!=C&&typeof K.createElement!=C,b=L.userAgent.toLowerCase(),c=L.platform.toLowerCase(),d=c?/win/.test(c):/win/.test(b),e=c?/mac/.test(c):/mac/.test(b),f=/webkit/.test(b)?parseFloat(b.replace(/^.*webkit\/(\d+(\.\d+)?).*$/,"$1")):!1,g=!1,h=[0,0,0],i=null;if(typeof L.plugins!=C&&typeof L.plugins[E]==D)i=L.plugins[E].description,!i||typeof L.mimeTypes!=C&&L.mimeTypes[G]&&!L.mimeTypes[G].enabledPlugin||(M=!0,g=!1,i=i.replace(/^.*\s+(\S+\s+\S+$)/,"$1"),h[0]=parseInt(i.replace(/^(.*)\..*$/,"$1"),10),h[1]=parseInt(i.replace(/^.*\.(.*)\s.*$/,"$1"),10),h[2]=/[a-zA-Z]/.test(i)?parseInt(i.replace(/^.*[a-zA-Z]+(.*)$/,"$1"),10):0);else if(typeof J.ActiveXObject!=C)try{var j=new ActiveXObject(F);j&&(i=j.GetVariable("$version"),i&&(g=!0,i=i.split(" ")[1].split(","),h=[parseInt(i[0],10),parseInt(i[1],10),parseInt(i[2],10)]))}catch(k){}return{w3:a,pv:h,wk:f,ie:g,win:d,mac:e}}();return!function(){U.w3&&((typeof K.readyState!=C&&"complete"==K.readyState||typeof K.readyState==C&&(K.getElementsByTagName("body")[0]||K.body))&&a(),R||(typeof K.addEventListener!=C&&K.addEventListener("DOMContentLoaded",a,!1),U.ie&&U.win&&(K.attachEvent(I,function(){"complete"==K.readyState&&(K.detachEvent(I,arguments.callee),a())}),J==top&&!function(){if(!R){try{K.documentElement.doScroll("left")}catch(b){return setTimeout(arguments.callee,0),void 0}a()}}()),U.wk&&!function(){return R?void 0:/loaded|complete/.test(K.readyState)?(a(),void 0):(setTimeout(arguments.callee,0),void 0)}(),c(a)))}(),!function(){U.ie&&U.win&&window.attachEvent("onunload",function(){for(var a=Q.length,b=0;a>b;b++)Q[b][0].detachEvent(Q[b][1],Q[b][2]);for(var c=P.length,d=0;c>d;d++)n(P[d]);for(var e in U)U[e]=null;U=null;for(var f in swfobject)swfobject[f]=null;swfobject=null})}(),{registerObject:function(a,b,c,d){if(U.w3&&a&&b){var e={};e.id=a,e.swfVersion=b,e.expressInstall=c,e.callbackFn=d,O[O.length]=e,u(a,!1)}else d&&d({success:!1,id:a})},getObjectById:function(a){return U.w3?g(a):void 0},embedSWF:function(a,c,d,e,f,g,j,k,m,n){var o={success:!1,id:c};U.w3&&!(U.wk&&U.wk<312)&&a&&c&&d&&e&&f?(u(c,!1),b(function(){d+="",e+="";var b={};if(m&&typeof m===D)for(var p in m)b[p]=m[p];b.data=a,b.width=d,b.height=e;var q={};if(k&&typeof k===D)for(var r in k)q[r]=k[r];if(j&&typeof j===D)for(var t in j)typeof q.flashvars!=C?q.flashvars+="&"+t+"="+j[t]:q.flashvars=t+"="+j[t];if(s(f)){var v=l(b,q,c);b.id==c&&u(c,!0),o.success=!0,o.ref=v}else{if(g&&h())return b.data=g,i(b,q,c,n),void 0;u(c,!0)}n&&n(o)})):n&&n(o)},switchOffAutoHideShow:function(){T=!1},ua:U,getFlashPlayerVersion:function(){return{major:U.pv[0],minor:U.pv[1],release:U.pv[2]}},hasFlashPlayerVersion:s,createSWF:function(a,b,c){return U.w3?l(a,b,c):void 0},showExpressInstall:function(a,b,c,d){U.w3&&h()&&i(a,b,c,d)},removeSWF:function(a){U.w3&&n(a)},createCSS:function(a,b,c,d){U.w3&&t(a,b,c,d)},addDomLoadEvent:b,addLoadEvent:c,getQueryParamValue:function(a){var b=K.location.search||K.location.hash;if(b){if(/\?/.test(b)&&(b=b.split("?")[1]),null==a)return v(b);for(var c=b.split("&"),d=0;d<c.length;d++)if(c[d].substring(0,c[d].indexOf("="))==a)return v(c[d].substring(c[d].indexOf("=")+1))}return""},expressInstallCallback:function(){if(S){var a=p(H);a&&w&&(a.parentNode.replaceChild(w,a),x&&(u(x,!0),U.ie&&U.win&&(w.style.display="block")),y&&y(z)),S=!1}}}}();libdom={markAsNotInLibrary:function(a){$(".song[data-id="+a+"]").addClass("not-in-library").removeClass("in-library")},markAsInLibrary:function(a){var b=$(".song[data-id="+a+"]");b.removeClass("not-in-library").addClass("in-library")},addSongsToPlaylistLocal:function(a,b){chinchilla.playlists,chinchilla.playlists=_.map(chinchilla.playlists,function(c){return c.url==a&&_.each(b,function(a){c.tracks.push(a)}),c})},removeSongsFromPlaylistLocal:function(a,b){chinchilla.playlists,chinchilla.playlists=_.map(chinchilla.playlists,function(c){return c.url==a&&_.each(b,function(a){c.tracks=_.without(c.tracks,a)}),c})}},library={add:function(a){var b={destination:"library",tracks:[a.id],token:chinchilla.token,type:"library"};socket.emit("add-tracks-to-collection",b),libdom.markAsInLibrary(a.id),notifications.create("Adding..."),$(".library-button").text("Remove from library").removeClass("library-button").addClass("library-remove-button")},batchAdd:function(a){var b={destination:"library",tracks:_.pluck(a,"id"),token:chinchilla.token,type:"library"};socket.emit("add-tracks-to-collection",b),notifications.create("Adding..."),_.each(a,function(a){libdom.markAsInLibrary(a.id)})},remove:function(a){socket.emit("remove-track",{destination:"library",song:a,token:chinchilla.token}),libdom.markAsNotInLibrary(a.id),notifications.create("Removing..."),$(".library-remove-button").text("Add to library").removeClass("library-remove-button").addClass("library-button"),$('#view[data-route="/library"] .song[data-id="'+a.id+'"]').remove()}},playlist={add:function(a,b){var c={destination:b,tracks:[a.id],token:chinchilla.token,type:"playlist"};socket.emit("add-tracks-to-collection",c),notifications.create("Adding...")}};var select=function(a){if(a.shiftKey)return shiftSelect(this),void 0;if(a.ctrlKey||a.metaKey)return cmdSelect(this),void 0;var b=a.srcElement||a.target;if(!$(b).hasClass("heart")&&void 0==b.dataset.navigate){if($(this).hasClass("selected")&&(0==a.button||document.getElementsByClassName("selected").length<2)){var c=$(".song.selected").not(this),d=$(this);return $(document).one("mouseup",function(){d.addClass("selected"),$(c).removeClass("selected")}),dragsongs(a),void 0}if(0==a.button||document.getElementsByClassName("selected").length<2){var c=$(".song.selected").not(this);$(this).addClass("selected"),$(c).removeClass("selected"),dragsongs(a)}}},dragsongs=function(a){var b={x:a.clientX,y:a.clientY},c=_.map($(".selected"),function(a){return a.dataset}),d=$(".playlistmenuitem, .librarymenuitem");1==c.length?$("#draglabel").text(c[0].name+" - "+c[0].artist):$("#draglabel").text(c.length+" tracks"),document.body.style.cursor="default",$(document).on("mousemove",function(a){var c=Math.sqrt(Math.pow(Math.abs(a.clientX-b.x),2)+Math.pow(Math.abs(a.clientY-b.y),2));c>20&&$("#draglabel").css({top:a.clientY-30,left:a.clientX}).show()}),d.on("mouseenter",function(){$(this).addClass("droppableindicator")}),d.on("mouseleave",function(){$(this).removeClass("droppableindicator")}),d.one("mouseup",function(){$(this).removeClass("droppableindicator");var a=$(this).attr("data-navigate");socket.emit("add-tracks-to-collection",{token:chinchilla.token,tracks:_.pluck(c,"id"),destination:"/library"==a?"library":a,type:"/library"==a?"library":"playlist"})}),$(document).one("mouseup",function(){$(document).off("mousemove"),$("#draglabel").hide(),d.off("mouseenter mouseup")})};window.playSong=function(a){if(!$(a.srcElement||a.target).hasClass("heart")){var b=$(this).nextAll(".song");player.queue2.clear(),$.each(b,function(a,b){player.queue2.add(b)}),player.playSong(this)}};var shiftSelect=function(a){var b=$(a),c=b.prevAll(".selected")[0],d=b.nextAll(".selected")[0];void 0!==c&&b.prevUntil(c,".song").andSelf().addClass("selected"),void 0!==d&&b.nextUntil(d,".song").andSelf().addClass("selected")},cmdSelect=function(a){$(a).toggleClass("selected")},dragSeek=function(){var a=224;player.automaticseekblocked=!0;var b=function(b){var c=b.pageX;$("#seek-progress").css("width",100*(c/a)+"%")};$(document).on("mousemove",b),$(document).one("mouseup",function(b){$(document).off("mousemove");var c=b.pageX;if(c>224)var c=224;player.seek(c/a*ytplayer.getDuration()),player.automaticseekblocked=!1})},resume=function(){player.play()},pause=function(){player.pause()},skip=function(){player.playNext()},rewind=function(){player.playLast()},tooltip=function(){var a=this,b=$("<div>",{"class":"tooltip"}).css({top:$(a).offset().top+$(a).height()+3,left:$(a).offset().left}).html($(a).attr("data-tooltip")).appendTo("body");$(a).mouseout(function(){$(b).remove()})},autocomplete=function(a){if(37!=a.keyCode&&38!=a.keyCode&&39!=a.keyCode&&40!=a.keyCode&&13!=a.keyCode&&16!=a.keyCode){var b=$("#search-field"),c=b.val(),d=$("#search-results"),e=$("#clear-input");if(window.lastsearchtimestamp){var f=Date.now();window.lastsearchtimestamp=f,setTimeout(function(){f==window.lastsearchtimestamp&&search.autocomplete(c)},500)}else window.lastsearchtimestamp=Date.now();""===c?(d.slideUp(300),e.hide()):(d.slideDown(300),e.show())}},addtrack=function(a){if(37!=a.keyCode&&38!=a.keyCode&&39!=a.keyCode&&40!=a.keyCode&&13!=a.keyCode&&16!=a.keyCode){var b=$(".add-tracks-input"),c=b.val();if($(".add-tracks-results"),window.lastsearchtimestamp){var d=Date.now();window.lastsearchtimestamp=d,setTimeout(function(){d==window.lastsearchtimestamp&&addtracks.autocomplete(c)},200)}else window.lastsearchtimestamp=Date.now()}},logout=function(){for(var a=document.cookie.split(";"),b=0;b<a.length;b++){var c=a[b],d=c.indexOf("="),e=d>-1?c.substr(0,d):c;document.cookie=e+"=;expires=Thu, 01 Jan 1970 00:00:00 GMT"}window.location.reload()},addtolib=function(){if($(this).hasClass("song")||$(this).hasClass("library-button"))var a=this;else var a=$(this).parents(".song")[0];var b=helpers.parseDOM(a);library.add(b)},remfromlib=function(){if($(this).hasClass("song")||$(this).hasClass("library-remove-button"))var a=this;else var a=$(this).parents(".song")[0];var b=helpers.parseDOM(a);library.remove(b)},clearinput=function(){$("#search-field").val("").keyup(),window.lastsearchtimestamp=null},rightclick=function(a){a.preventDefault();var b={song:helpers.parseDOM(a.currentTarget),e:a,left:a.pageX};contextmenu(b)},playlistmenu=function(a){a.preventDefault();var b={e:a,left:a.pageX,playlist:a.currentTarget};contextmenu(b)},contextmenu=function(a){$(".contextmenu").remove();var b=a.song?"#view":"#sidebar";$(b)[0].scrollHeight;var c=$(document).height(),d={top:a.e.pageY,left:a.left,bottom:c-a.e.pageY};console.log("obj.e.pageY",a.e.pageY,"height",c,"offsets.top",d.top,"offsets.bottom",d.bottom);var e=a.e.pageY<c/2?d.top:d.bottom,f=a.e.pageY<c/2?"top":"bottom",g=$("<div>",{"class":"contextmenu"}).css({left:d.left}).css(f,e).html('<div class="loading-indicator"><div class="spinner"></div></div>').appendTo(b);if($(document).one("click",function(){g.remove()}),a.song){$(document).one("click",".contextmenu-add-to-playlist",function(a){$(this).parents(".context-options").html(loader.spinner()),a.stopPropagation(),socket.emit("add-playlist-dialogue",{song:this.dataset.id,token:chinchilla.token}),socket.once("add-playlist-dialog-response",function(a){$(".context-options").html(a.html)})});var h=a.song,i=templates.buildSongContextMenu({song:h,inlib:_.contains(chinchilla.library,parseFloat(h.id)),loggedin:chinchilla.loggedin});g.html(i)}else if(a.playlist){var j=a.playlist.dataset.navigate;socket.emit("get-playlist-contextmenu",{playlist:j,state:chinchilla}),socket.once("playlist-contextmenu",function(a){g.addClass("playlist-contextmenu"),g.html(a.html)})}},setchange=function(){var a=$(".settings .setting"),b=[];$.each(a,function(a,c){var c={key:c.dataset.setting,label:$(c).find("span").text(),value:$(c).find("input").is(":checked")};b.push(c),chinchilla.settings[c.key]=c.value}),socket.emit("update-settings",{settings:b,token:chinchilla.token}),notifications.create("Saving..."),socket.once("settings-saved",function(){notifications.create("Settings saved.")})},ordersongs=function(){var a,b=$(this);b.hasClass("ascending")?(b.addClass("descending"),b.removeClass("ascending"),a="desc"):b.hasClass("descending")?(b.removeClass("descending"),a="default"):(b.addClass("ascending"),a="asc"),$(b).siblings("th").removeClass("ascending descending");var c="default"==a?"index":b.attr("data-value"),d=b.parents("table").eq(0),e=$(d).find(".song"),f=_.sortBy(e,function(a){var b=a.dataset[c];return isNaN(b)?b:parseFloat(b)});"desc"==a?f.reverse():f,html="",e.remove(),$.each(f,function(a,b){d.append(b)})},playalbum=function(){var a=$(this).parents(".album"),b=a.find(".song.recognized"),c=b.splice(0,1)[0];player.queue2.clear(),$.each(b,function(a,b){player.queue2.add(b)}),player.playSong(c)},findindom=function(a){var b=$(a).attr("data-id");return $(".song[data-id="+b+"]").eq(0)[0]},findandplay=function(a){var b=findindom(this);return $(a.currentTarget).hasClass("visual-play-button")?(playbutton(b,a),void 0):(player.playSong(b),void 0)},playbutton=function(a){var b=helpers.parseDOM(a),c=player.nowPlaying.get();if(c&&b.id==c.id){var d=ytplayer.getPlayerState();1==d?ytplayer.pauseVideo():(ytplayer.playVideo(),$(".now-playing").addClass("hearable"))}else player.playSong(b),$(".now-playing").addClass("hearable")},findandqueue=function(){var a=_.pluck(player.queue1.get(),"duration"),b=_.reduce(a,function(a,b){return a+parseFloat(b)},0),c=ytplayer.getCurrentTime(),d=ytplayer.getDuration();untilplayed=b+1e3*d-1e3*c,label=helpers.parsehours(untilplayed),song=findindom(this),player.queue1.add(song),notifications.create(helpers.parseDOM(song).name+" was added to the queue. It will be played in "+label+".")},addalbumtolib=function(){var a=$(this).parents(".album"),b=a.find(".song.recognized"),c=[];$.each(b,function(a,b){c.push(helpers.parseDOM(b))}),library.batchAdd(c)},addtrackskeys=function(a){var b="add-tracks-selected";if(13==a)$("."+b).click();else{var c=$("."+b),d=38==a?"prev":"next",e=c[d]("span");0!=e.length&&($(e).addClass(b),$(c).removeClass(b))}},searchkeys=function(a){var b="search-selected";if(13==a)$("."+b).mousedown();else{var c=$("."+b),d=38==a?"prev":"next",e=c[d]("li");0!=e.length&&($(e).addClass(b),$(c).removeClass(b))}},keysdown=function(a){var b=a.keyCode;if(40==b||38==b){if(a.preventDefault(),a.stopPropagation(),$(".add-tracks-input").is(":focus"))return addtrackskeys(b),void 0;if($("#search-field").is(":focus"))return searchkeys(b),void 0;var c=$(".song.selected"),d=40==b?"next":"prev",e=c[d](".song").addClass("selected");a.shiftKey||0==e.length||c.removeClass("selected")}},keys=function(a){var b=a.keyCode,c=a.srcElement||a.target;if(!$(c).is("input")||$(c).is(".add-tracks-input")||$(c).is("#search-field")){if(a.preventDefault(),13==b){if($(".add-tracks-dropdown").is(":visible"))return addtrackskeys(b),void 0;if($("#search-results").is(":visible"))return a.preventDefault(),searchkeys(b),void 0;var d=$(".song.selected.recognized"),e=d[d.length-1],f=d.splice(0,1);player.playSong(f[0]),player.queue2.clear(),_.each(d,function(a){player.queue1.add(a)});var g=$(e).nextAll(".song.recognized");$.each(g,function(a,b){player.queue2.add(helpers.parseDOM(b))})}39==b&&player.playNext(),37==b&&player.playLast(),32==b&&($("input").is(":focus")||player.togglePlayState())}},hidenotification=function(){$(this).parents(".notification").remove()},warnexit=function(){return chinchilla.loggedin&&chinchilla.settings.warn_before_leave?"You are leaving the page but the music is still playing. Do you really want to leave? (You can turn this notification off in the settings)":void 0},showalbum=function(){$(this).hide().next(".hidden-album-container").show()},newplaylist=function(){$(".new-playlist-input").show().find("input").val("").focus(),$("html").one("click",function(){$(".new-playlist-input").hide().off(),$(".new-playlist-input-field").off()}),$(".new-playlist-input").on("click",function(a){a.stopPropagation()}),$(".new-playlist-input-field").on("keypress",submitplaylist)},submitplaylist=function(a){if(13==a.keyCode){var b=$(".new-playlist-input-field"),c=b.val();b.off(),socket.emit("add-playlist",{name:c,token:chinchilla.token})}},renameplaylist=function(){function a(a){var b=document.createRange();b.selectNodeContents(a);var c=window.getSelection();c.removeAllRanges(),c.addRange(b)}var b=this.dataset.id,c=this.dataset.name,d=$('#sidebar [data-navigate="'+b+'"]'),e=d.find(".pl-label").attr("contenteditable",!0).focus();$(e).on("keypress",function(a){13==a.keyCode&&($(e).off().removeAttr("contenteditable"),$("body").off(),socket.emit("rename-playlist",{oldname:b,newname:$(e).text(),token:chinchilla.token}),$(d).hide())}),a($(e)[0]),$("body").one("click",function(){$(e).off().removeAttr("contenteditable"),$(e).text(c)}),$(e).on("click",function(a){a.stopPropagation()})},deleteplaylist=function(){var a=this.dataset.id;$('#sidebar [data-navigate="'+a+'"]'),socket.emit("delete-playlist",{url:a,token:chinchilla.token})},suppressrenaming=function(a){a.stopPropagation()},addsongtopl=function(){var a=this.dataset,b={type:"playlist",tracks:[a.songid],token:chinchilla.token,destination:a.url};socket.emit("add-tracks-to-collection",b),notifications.create("Adding...")},remsongfrompl=function(){var a=this.dataset;a.token=chinchilla.token,a.songid=parseFloat(a.songid),socket.emit("remove-song-from-playlist",a)},pldropdown=function(){socket.emit("get-playlist-options",{playlist:$("#view").attr("data-route"),token:chinchilla.token}),socket.once("playlist-options",function(a){$(".playlist-options-dropdown").html(a.html)})},mkplpublic=function(){$(".make-playlist-public").addClass("dropdown-check").removeClass("dropdown-no-check"),$(".make-playlist-private").addClass("dropdown-no-check").removeClass("dropdown-check");var a=$("#view").attr("data-route");$(".playlist-privacy"),socket.emit("change-playlist-privacy",{playlist:a,token:chinchilla.token,"public":!0})},mkplprivate=function(){$(".make-playlist-public").removeClass("dropdown-check").addClass("dropdown-no-check"),$(".make-playlist-private").removeClass("dropdown-no-check").addClass("dropdown-check");var a=$("#view").attr("data-route");$(".playlist-privacy"),socket.emit("change-playlist-privacy",{playlist:a,token:chinchilla.token,"public":!1})},mkplnwattop=function(){$(".make-playlist-newest-at-top").removeClass("dropdown-no-check").addClass("dropdown-check"),$(".make-playlist-newest-at-bottom").addClass("dropdown-no-check").removeClass("dropdown-check");var a=$("#view").attr("data-route");$(".playlist-privacy"),socket.emit("change-playlist-order",{playlist:a,token:chinchilla.token,newestattop:!0}),chinchilla.playlists=_.map(chinchilla.playlists,function(b){return b.url==a&&(b.newestattop=!0),b})},mkplnwatbottom=function(){$(".make-playlist-newest-at-top").addClass("dropdown-no-check").removeClass("dropdown-check"),$(".make-playlist-newest-at-bottom").removeClass("dropdown-no-check").addClass("dropdown-check");var a=$("#view").attr("data-route");$(".playlist-privacy"),socket.emit("change-playlist-order",{playlist:a,token:chinchilla.token,newestattop:!1}),chinchilla.playlists=_.map(chinchilla.playlists,function(b){return b.url==a&&(b.newestattop=!1),console.log(b,a),b})},closenotification=function(){$("#statusbar").hide()},playallsongs=function(){var a=$(".song"),a=_.shuffle(a),b=a.splice(0,1)[0];player.queue2.clear(),_.each(a,function(a){player.queue2.add(a)}),player.playSong(b)},playallsongsinorder=function(){var a=$(".song"),b=a.splice(0,1)[0];player.queue2.clear(),_.each(a,function(a){player.queue2.add(a)}),player.playSong(b)},hoversearchresult=function(){var a="search-selected";$("."+a).removeClass(a),$(this).addClass(a)},filterdropdown=function(){var a=this.dataset.list;templates.buildFilter({list:a})},preventScrolling=function(a){var b=a.keyCode;return b>=37&&40>=b?!1:void 0},trigger=function(){this.dataset.untrigger=this.dataset.trigger,$("."+this.dataset.trigger).show(),delete this.dataset.trigger},untrigger=function(){this.dataset.trigger=this.dataset.untrigger,$("."+this.dataset.untrigger).hide(),delete this.dataset.untrigger},loadcover=function(){$(this).fadeIn().addClass("coverstack-coer-loaded")},showYouTubePage=function(){$("body").addClass("youtube-player-visible"),$("#view").html(""),$.publish("view-got-loaded")},hideYouTubePage=function(){$("body").removeClass("youtube-player-visible")},showImportPage=function(){var a=$("#import-template").html(),b=_.template(a,{importqueue:importqueue,tracktmpl:$("#import-track-template").html(),playlists:chinchilla.playlists});$("#view").html(b),$("#playlist-target").val(chinchilla.playlist_target?chinchilla.playlist_target:"/library"),$.publish("view-got-loaded")},startqueue=function(){startQueue()},stopqueue=function(){stopQueue()},pltargetchanged=function(){chinchilla.playlist_target=this.value};$(document).on("mousedown","tr.song",select).on("keyup","body",keys).on("keydown","body",keysdown).on("dblclick",".song",playSong).on("mousedown","#seek-bar",dragSeek).on("click","#play",resume).on("click","#pause",pause).on("click","#skip",skip).on("click","#rewind",rewind).on("mouseover","[data-tooltip]",tooltip).on("keyup","#search-field",autocomplete).on("keyup",".add-tracks-input",addtrack).on("click","#clear-input",clearinput).on("click",".play-button",playSong).on("click",".library-button",addtolib).on("click",".library-remove-button",remfromlib).on("click",".not-in-library .heart",addtolib).on("click",".in-library .heart",remfromlib).on("click","#logout",logout).on("contextmenu",".song.recognized, .queue-song",rightclick).on("contextmenu",".playlistmenuitem",playlistmenu).on("change",".settings input",setchange).on("click","[data-order]",ordersongs).on("click",".play-all-album",playalbum).on("click",".add-all-album",addalbumtolib).on("click",".findandplay",findandplay).on("click",".findandqueue",findandqueue).on("click",".notification .actions span",hidenotification).on("click",".albumhidden-message",showalbum).on("click",".add-new-playlist",newplaylist).on("click",".rename-playlist-button",renameplaylist).on("click",".pl-label[contenteditable]",suppressrenaming).on("click",".delete-playlist-button",deleteplaylist).on("click",".add-song-to-playlist-button",addsongtopl).on("click",".remove-song-from-playlist-button",remsongfrompl).on("click",".playlist-privacy",pldropdown).on("click",".make-playlist-public",mkplpublic).on("click",".make-playlist-private",mkplprivate).on("click",".make-playlist-newest-at-top",mkplnwattop).on("click",".make-playlist-newest-at-bottom",mkplnwatbottom).on("click",".close-notification",closenotification).on("click",".play-all-songs",playallsongs).on("click",".play-all-songs-in-order",playallsongsinorder).on("hover","#search-results-wrapper li",hoversearchresult).on("click",".show-filter-dropdown",filterdropdown).on("keydown",preventScrolling).on("click","[data-trigger]",trigger).on("click","[data-untrigger]",untrigger).on("click","#start-queue",startqueue).on("click","#stop-queue",stopqueue).on("change","#playlist-target",pltargetchanged),$(window).on("beforeunload",warnexit),$(document).ready(function(){$.subscribe("new-tracks-entered-dom",function(){var a=$(".not-recognized");recognition.queue.clear(),_.each(a,function(a){recognition.queue.push(a)});var b=player.nowPlaying.get();if(b){var c=$('.song[data-id="'+b.id+'"]');c.addClass("now-playing"),ytplayer.getPlayerState&&1==ytplayer.getPlayerState()&&c.addClass("hearable")}}),$.subscribe("view-gets-loaded",function(){$("#view").addClass("view-loading")}),$.subscribe("view-got-loaded",function(){$("#view").removeClass("view-loading")})}),function(a){var b=a({});a.subscribe=function(){b.on.apply(b,arguments)},a.unsubscribe=function(){b.off.apply(b,arguments)},a.publish=function(){b.trigger.apply(b,arguments)}}(jQuery);var SongsCollection,PlaylistCollection,storeReady=function(){SongsCollection=songsdb},plStoreReady=function(){PlaylistCollection=pldb},songsdb=new IDBStore({storeName:"songs"},storeReady),pldb=new IDBStore({storeName:"playlists"},plStoreReady);DB={},DB.getTracks=function(a){SongsCollection?songsdb.query(function(b){var c=_.map(b,function(b){return _.contains(a.ids,b.id)?b:null}),d=_.compact(c),e=_.map(d,function(a){return a.inlib=_.contains(chinchilla.library,a.id),a});a.callback(e)}):setTimeout(function(){DB.getTracks(a)},100)},DB.addTrack=function(a){SongsCollection?songsdb.put(a):setTimeout(function(){DB.addTrack(a)},100)},DB.addYTIDToTrack=function(a,b){SongsCollection?songsdb.query(function(c){var d=_.map(c,function(b){return b.id==a.id?b:null}),e=_.compact(d);if(e.length>0){var f=e[0];f.ytid=b,DB.addTrack(f)}}):setTimeout(function(){DB.addYTIDToTrack(a)},100)},remote={updateTrack:function(){chinchilla.paired&&(console.log("Paired"),socket.emit("/pairing/update-info",{playing:player.nowPlaying.get(),code:chinchilla.paired}))}};